# 1. Team Info (팀 정보)

- **과제명**: 비임상적 소비 스트레스를 겪는 20대 여성을 위한, 인지행동치료 기반 LangGraph 상담 챗봇
- **팀 정보**: 28팀 e스타트
- **팀 구성원**
  - 유희정(1976250): 리더, 기획, 논문 조사, 프론트엔드, 백엔드
  - 최윤우(2176387): 팀원, DB(Firestore) 구조 설계
  - 이경림(1871033): 팀원, 기획, 논문조사, 제출 과제 준비

# 2. Project-Summary (과제 요약)

## 2.1. 문제 정의

### 2.1.1. 배경

### 1) 충동 소비(IB)와 강박적 소비장애(CBD)의 정의

- **충동 소비(Impulse Buying, IB)**: “Impulse purchases occur when there is a sudden and strong emotional desire, which arises from a reactive behavior that is characterized by low cognitive control… despite being aware of the negative effects of buying, there is an enormous desire to immediately satisfy the most pressing needs.” 감정적 충동과 낮은 자기 통제 속에서 이루어지는, 즉각적인 욕구 충족을 목표로 한 구매 (Rodrigues et al.,2021)
- **강박적 소비장애(Compulsive Buying Disorder, CBD)**
    - “excessive shopping cognitions and buying behavior that leads to distress or impairment.” 과도한 구매 사고 및 행동으로 인해 개인의 삶에 손상이나 고통을 초래하는 장애 (Black, 2007).
    - 진단 기준 (Black, 2007; Tavares et al., 2008)
        - 지속적 구매 충동: 반복적이고 저항하기 어려운 구매 욕구
        - 통제 실패: 불필요한 물품을 반복적으로 구입
        - 부정적 결과: 심각한 재정적 문제, 정서적 고통, 사회적 기능 저하
        - 배제 기준: 조증 상태 등 다른 정신질환으로 설명되지 않아야 함

### 2) 충동 소비(IB)와 강박적 소비장애(CBD)의 연결성

충동구매(Impulse Buying, IB)와 강박적 소비장애(Compulsive Buying Disorder, CBD)는 모두 계획되지 않은 즉흥적 구매와 관련이 있다는 점에서 공통점을 가지지만, 그 심각성과 결과에서 차이를 보인다. IB는 일시적이고 상황에 따라 발생할 수 있는 소비 행태로, 구매 후 후회나 과소비 경험을 유발하나 일상적 수준에서 머무를 수 있다. 반면, CBD는 반복적이고 만성적으로 지속되는 구매 충동으로, 개인이 통제하기 어려울 정도로 강력하며 결과적으로 심각한 재정적·정서적 손해를 초래한다 (Black, 2007; Tavares et al., 2008). 특히 연구에 따르면, 청소년기나 초기 성인기의 통제되지 않은 IB는 시간이 지남에 따라 만성적·재발적 양상을 띠며 CBD로 발전할 가능성이 높다 (Tavares et al., 2008; Black, 2007). 따라서 IB는 단순한 소비 습관 차원을 넘어, 방치될 경우 병리적 수준의 장애로 악화될 수 있는 전구 단계(preclinical stage)로 이해할 수 있으며, 이 시점에서의 개입은 CBD로의 진행을 예방하는 데 중요한 역할을 한다.

### 3) 충동 소비(IB)와 강박적 소비장애(CBD)의 회색 지대

현대 사회에서 충동성 소비(Impulse Buying, IB) 는 많은 젊은 층, 특히 20대 여성 사이에서 빈번하게 나타나지만, 이들이 겪는 어려움은 병리적 수준(Compulsive Buying Disorder, CBD, 강박적 소비장애) 에 이르지는 않아 진단이나 치료 대상이 되지 않는 경우가 많다.
이들이 처한 '회색지대'에는 다음과 같은 문제들이 존재한다.<br>

- **진단 기준 미달**: CBD 수준으로 진단받을 만한 기준은 충족하지 않지만, 반복적인 과소비 충동과 후회 경험이 반복된다.
- **생활 불편 및 스트레스**: 소비 후 후회, 채무 압박, 자기 통제 실패 경험 등이 정서적 부담과 스트레스를 유발한다.
- **심리적 진입장벽**: 정식 심리 상담이나 치료는 '회색 지대'에 위치한 사람이 감당하기에는 비용 부담, 시간 부담, 낙인 문제 등으로 인해 접근성이 낮다.
- **CBD로의 전이 가능성**: 일부 연구에서는 IB가 방치되면 CBD 수준으로 발전할 가능성이 있음이 제시된다.(Black, 2007; Tavares et al., 2008)

### 4) 설문조사를 통해 발견한 충동 소비(IB)와 강박적 소비장애(CBD)의 회색 지대

아래는 올해 9월 2일부터 9월 6일까지, 총 5일 간 학내 커뮤니티를 통해 20대 여성을 대상으로 진행한 설문조사 결과이다.

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/1635f801-e7b3-4839-9bfe-9a20175defa9" />

### 2.1.2. 문제 정의

강박적 소비장애(Compulsive Buying Disorder, CBD) 는 반복적이고 통제하기 어려운 구매 충동을 특징으로 하며, 결국 재정적·정서적 손해로 이어진다 (Tavares et al., 2008). 임상 연구에 따르면 CBD 환자의 80~94%가 여성으로 보고된다(Tavares et al., 2008).

그러나 모든 문제가 CBD로 진단되는 것은 아니다. 실제로 많은 소비자들이 CBD 진단 기준에는 해당하지 않지만, 반복적인 IB로 생활의 불편과 스트레스를 겪는 ‘회색지대’에 놓여 있다. 이들은 전문 상담을 받기에는 진입 장벽이 높고, 결과적으로 적절한 개입 없이 방치되는 상황에 처한다.

또한 연구는 IB가 단순한 습관 차원의 문제가 아니라, 반복될 경우 CBD로 진행될 수 있는 전구 단계임을 보여준다 (Black, 2007; Darrat et al., 2016). 특히 IB와 CBD는 공통된 심리적 기전(불안, 부정적 감정 대처)을 공유하며 (Darrat et al., 2016), 따라서 여성 집단에서 CBD 비율이 높은 점을 고려할 때, CBD로 진단되지 않은 심각한 IB 역시 여성에게서 더 빈번할 가능성이 있다.

### 2.1.3. 필요성

IB는 전체 소비의 40~80%를 차지하는 보편적 행태임에도 (Rodrigues et al., 2021), 반복되면 개인의 재정·정서적 건강을 심각하게 위협하며, 죄책감·후회·우울과 같은 부정적 감정 악순환을 유발한다 (Miltenberger et al., 1995; Verplanken et al., 2005). 그럼에도 불구하고 회색지대 소비자들은 기존의 고비용 치료 시스템으로 접근하기 어려워, 조기 개입의 공백이 존재한다.

따라서 본 프로젝트는 이러한 회색지대 소비자를 대상으로, 저비용·고접근성의 CBT 기반 개입 솔루션을 설계한다. 이를 통해 사용자가 소비 충동의 원인을 인식하고, 대체 행동 전략을 학습하며, 장기적으로는 CBD로의 진행을 예방하는 것을 목표로 한다.

## 2.2. 기존 서비스와의 비교

앱스토어에서 '소비 습관' 키워드로 검색했을 때 대개 소비 내역에 대한 기초적인 분석(카테고리별 소비 비율, 전월 대비 소비 증감, 지출 현황, 지출 패턴 분석)만을 제공해주는 가계부가 제일 많았다.  소비 습관 형성을 도와주는 서비스 또한 존재했는데, 그 수준이 단순한 챌린지를 제공하는 수준에 그쳤다. 각 유사 서비스의 소비 습관 코칭 기능과 한계점은 아래와 같다. 하지

- Fig, 굴비잇기, 지금 - 지금 실천하는 금융 챌린지
    - 챌린지 기반. 소비 유형을 MBTI 16가지 유형으로 나누어 각 사용자에게 맞는 챌린지
    - 사용자를 몇 가지 유형으로 나누기 때문에 완전 맞춤은 불가능하다는 단점이 있고, 소비자의 소비 패턴을 분석해도 각자에게 맞는 챌린지를 제공해줄 뿐, 챌린지 이외의 다른 해결책을 제시하지 못한다.
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/f57b31e3-4372-4ac1-a3b4-77e09176dc1b" />
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/04d93d8d-39b3-4405-9ac9-14356b026b2e" />

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/7a170919-c99b-4175-b227-3c027171032c" />
<img height="200" alt="Image" src="https://github.com/user-attachments/assets/e08ff2a4-e69a-4054-be6f-a788324302dc" />
<img height="200" alt="Image" src="https://github.com/user-attachments/assets/bc64d89d-82ef-4441-8c78-dd19b7e6dabe" />

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/3f2285cd-7216-45ab-a4ac-badbb5ee7110" />

- 구매 습관 개선: 스마트한 소비 관리와 절약 앱(Kazuya Saito)
    : 물건 구매 전에 물건 구매 화면을 캡쳐하여 등록하면 구매를 저지할 수 있는 말을 이미지를 통해 자동생성하여 보여준다. 다만 매 소비 때마다 사진을 입력해야 하며, 소비 전에 구매 화면을 입력했을 때에 이 구매가 현명한 판단인지 아닌지 생각하게끔 하는 서비스이다.
    - 차별점: 충동 소비에 대한 체계적인 상담 프로그램을 적용하여 충동 소비 습관을 교정해주는 역할은 하지 못한다.
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/52daf50f-ddbe-4777-a39d-305fb1a02563" />
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/2fc2b2bf-c2aa-4c0f-b040-ac268e075cec" />

## 2.3. 제안 내용

충동구매(Impulse Buying, IB)와 강박적 소비장애(Compulsive Buying Disorder, CBD)는 서로 다른 진단적 범주에 속하지만, 두 현상은 공통된 심리·행동 기전을 공유한다. 구조방정식 모형 연구에 따르면, 충동구매는 불안을 유의하게 증가시키며, 이러한 불안은 다시 CBD와 밀접하게 연결되는 것으로 나타났다(Darrat, Darrat, & Amyx, 2016). 이는 IB가 단순한 소비 습관에 그치지 않고, 정서 조절 실패를 매개로 CBD로 진행할 수 있음을 보여준다.

한편, CBD 치료에서 가장 효과가 입증된 접근법은 인지행동치료(Cognitive Behavioral Therapy, CBT)이다(Mitchell, Burgard, Faber, Crosby, & de Zwaan, 2006;Leite, Pereira, Nardi, & Silva, 2014).

최근에는 ChatGPT와 같은 대형언어모델(LLM) 챗봇이 실제로 정신건강 상담 도구로 활용되는 사례가 늘어나고 있다(Dartmouth College, 2025; Leite, 2024; OM1, 2023; Vaidyam et al., 2024). 이는 LLM 챗봇이 전문 치료를 대체하지는 않더라도, 접근성이 높고 저비용으로 이용 가능한 ‘심리 코치’로 기능할 수 있음을 시사한다.

따라서 본 프로젝트는 CBD 치료에서 입증된 CBT 기법을 IB에 적용하는 것과 동시에, LLM 기반 챗봇을 코칭 솔루션으로 구현한다.

## 2.4. 기대 효과 및 의의

- CBD로 진단받지 못해 방치되는 회색지대 소비자들이 스스로의 소비 습관을 개선하기 위한 자기 관리 도구로 이용할 수 있다. 이를 통해 본인의 소비 습관에 대한 스트레스 경감 효과를 기대한다.
- 충동 장애에 대한 Digital Therapeutics(DTx) 개발 가능성을 제시한다.

## 2.5. 주요 기능 리스트 (Feature List)

**인지행동치료 모델(CBT) 기반 주간 상담(10주)** 을 중심으로 하고, 과제 수행을 돕는 FAQ 일반 상담, 행동 지속을 위한 리마인더 기능을 제공한다. 또한 상담 연속성과 사용자 편의를 위한 보조 기능(히스토리/새 FAQ/초기화)을 제공한다.

본 보고서에서는 구현 기능을 Feature의 약자인 **F(Feature)** 로 식별하고, 각 기능을 **F1, F2, …** 로 표기한다.

### 2.5.1. 핵심 기능

- Mitchell(2006)에서 진행된 총 10주차의 인지행동치료 집단 상담을 재구성하여 LLM API가 참고할 상담 지침을 yaml 파일로 구성한다. 본 보고서에서는 이것을 '상담 프로토콜'이라고 부른다. 프로토콜은 각 주차마다 하나의 파일로 구성되며, 주차, 주차별 상담 목표(session goal)과 주요 과업(core task), 성공 기준(success criteria), 사용 가능 기법(allowed_techniques), 과제(homework) 등으로 구성되어 있다.
  - Beck, J. S.(2011)에서 소개하는 인지행동치료 기법을 정리하여 yaml 파일로 구성한다.

- **F1. 주간 상담** (Weekly)
  - 목적: 10주 동안 소비 습관을 점진적으로 교정하기 위한 상담이 진행된다. 이때 챗봇이 상담가, 사용자가 내담자 역할을 한다.
  - 사용자 입력: 챗봇의 질문에 대한 응답.
  - 출력: 주차별 상담 대화와 (세션 종료 시) 주간 요약/다음 과제 안내.
  - 주간 상담은 Mitchell(2006)의 10주 CBT 집단상담 구조를 재구성한 **주차별 상담 프로토콜(YAML)** 을 로드하여 진행되며, LLM은 해당 프로토콜의 목표/과업/성공기준 및 허용 기법 범위 내에서 대화를 생성한다.
  - 또한 Beck(2011)의 CBT 기법을 정리한 **기법 라이브러리(YAML)** 를 참조하여 질문/개입을 구성한다.
- **F2. 일반 FAQ 상담** (General / FAQ)
  - 목적: 챗봇이 주간 상담에서는 다루지 않지만 관련이 있는 주제(주간 상담 과제나 상담 및 소비 습관)에 대한 질문에 답변한다.
  - 사용자 입력: 자유 질문(과제, 상담, 소비 관련 주제).
  - 출력: 사용자의 자유 질문에 대한 RAG 및 상담 요약 기반 답변.
  - 사용자의 질문에 대해 이전 주간 상담 요약과 직전 상담의 과제 맥락을 참고하고, 인지행동치료, 강박적소비장애, 충동 소비에 대한 논문을 기반으로 신뢰도 높은 답변을 제공한다.
- **F3. 리마인더 푸시 알림**
  - 목적: 사용자가 잊지 않고 과제를 수행할 수 있도록, 그리고 상담을 지속적으로 수행할 수 있도록 돕는 역할.

### 2.5.2. 보조 기능

- **F4. 과거 채팅방 접근** (History)
  - 목적: 사용자가 자기 기록을 복기하여 행동 변화를 강화한다.
  - 동작: 주간 상담은 조회 중심(기록 보존), 일반 FAQ는 이전 대화에 이어서 질의 가능.
- **F5. 새로운 FAQ 상담 시작**
  - 목적: 기존 FAQ 대화 맥락과 분리된 새 질문 세션을 열어, 주제 전환/정리된 상담을 가능하게 한다.
  - 동작: 새 GENERAL(FAQ) thread 생성.
- **F6. 초기화(1주차부터 재시작)**
  - 목적: 사용자가 언제든 프로그램을 재시작할 수 있게 하여 재도전 장벽을 낮추며, 10주차 상담 프로그램을 끝낸 후 다시 상담을 받고 싶을 때 재시작할 수 있다.
  - 동작: current_week 및 진행 상태만 리셋하고, 과거 채팅 기록은 보존(학습/복기 목적).

# 3. Project-Design (과제 설계)

## 3.1 요구사항 정의

> 표기 규칙  
> - TS = Test Scenario 

---

### F1. 주간 상담(Weekly)

#### 목적

10주 동안 주차별 CBT 상담을 진행하고, 세션 종료 시 **주간 요약 + 다음 과제** 를 제공한다. 대화는 **주차별 상담 프로토콜(YAML)** 과 **CBT 기법 라이브러리(YAML)** 을 범위 내에서 생성된다.

#### 상세 기능 요구사항

1) 주간 상담 진입 시, 챗봇이 먼저 상담을 안내하면서 사용자가 어떤 행동을 하면 되는지 안내하며 전체 상담을 주도하여야 한다.
2) 시스템은 사용자의 현재 주차(`current_week`)에 해당하는 주차별 프로토콜(YAML)을 로드해야 한다.  
3) LLM은 프로토콜의 목표/과업/성공기준/허용 기법 범위를 벗어나지 않도록 상담 발화를 생성해야 한다.  
4) 시스템은 대화를 **세션 단위(thread)** 로 저장하고, 각 메시지에 생성 시각/화자(role)/세션 식별자를 포함해야 한다.  
5) 시스템은 사용자의 답변을 기반으로 다음 질문/개입을 구성하되, 필요 시 **CBT 기법 라이브러리(YAML)** 를 참조하여 개입 유형을 선택해야 한다.  
6) 주간 상담 종료 조건(예: 목표 달성, 프로토콜 단계 완료 등)을 만족하면, 시스템은 **주간 요약**을 생성해야 한다.  
7) 주간 상담 종료 시, 시스템은 다음 주차까지 수행할 **과제(homework)** 를 사용자에게 안내하고 저장해야 한다.  
8) 앱 재접속/화면 이탈 후 복귀 시에도, 해당 Weekly 세션의 대화가 누락 없이 복원되어야 한다.  
9) 프로토콜 로드 실패/필수 필드 누락 시, 시스템은 오류를 기록하고 사용자에게 “상담을 시작할 수 없음” 상태를 안내해야 한다(무한 로딩 금지).
10) 사용자가 대화 중 상담 주제와 어긋나는 발화를 하면 이를 감지하고 상담으로 복귀할 수 있도록 유도한다.
11) 주간 상담 중에는 어떤 기능(초기화, 새 FAQ 세션 생성, 과거 채팅 접근)도 이용할 수 없다. 주간 상담이 종료되어야 한다.

#### 완료 기준(AC)

- AC1: 현재 주차가 N일 때, **N주차 프로토콜**로 상담이 시작된다(주차 mismatch 없음).  
- AC2: 상담 종료 시 **주간 요약 1개 + 과제 안내 1개**가 생성/저장된다.  
- AC3: 앱 재접속 후 Weekly 세션을 열면 **DB에 저장된 메시지가 시간순으로 모두 표시**된다.

#### 테스트 시나리오

- **TS-F1-01: 현재 주차에 맞는 Weekly 상담 시작(정상)**
  - 사전조건: 테스트 계정의 `current_week = 3`
  - 절차: 앱 실행 → 주간 상담 진입 → 첫 챗봇 질문 수신
  - 기대결과: 3주차 프로토콜로 대화가 시작됨(로그/응답필드로 week=3 확인) / 세션 타입이 WEEKLY로 생성됨  
- **TS-F1-02: 주간 상담 종료 시 요약/과제 생성(정상)**
  - 사전조건: 종료 조건을 만족하도록 프로토콜 단계 진행
  - 절차: 주간 상담을 종료 조건까지 진행
  - 기대결과: 주간 요약 1개와 과제 안내가 UI에 표시되고 DB에도 저장됨(요약 문서/필드 존재 확인)  
- **TS-F1-03: 재접속 복원(정상)**
  - 사전조건: WEEKLY 세션에서 최소 6턴(사용자/챗봇 포함) 진행 후 저장 완료 상태
  - 절차: 앱 강제 종료 → 재실행 → 히스토리에서 해당 Weekly 세션 열기
  - 기대결과: DB에 저장된 메시지가 시간순으로 모두 표시되고 챗봇 응답 누락이 없음 / 중복 렌더링 없음  
- **TS-F1-04: 프로토콜 로드 실패(예외)**
  - 사전조건: (테스트 환경에서) 특정 주차 YAML 파일 누락/필수 필드 제거
  - 절차: 해당 주차로 상담 시작 시도
  - 기대결과: 무한 로딩 없이 오류 상태 안내가 표시됨 / 서버에 오류 로그가 남음  

---

### F2. 일반 FAQ 상담(General/FAQ)

#### 목적

과제와 상담 또는 소비와 관련된 질문에 대해, **이전 주간 상담 요약/과제 맥락**을 참고하고, **RAG에서 관련 정보를 검색**하여 신뢰도 높은 답변을 제공한다.

#### 상세 기능 요구사항

1) 사용자가 질문하기 전에 챗봇이 먼저 일반 상담을 어떻게 사용할 수 있는지 안내해야 한다.
2) 시스템은 질문 처리 시, 사용자의 **이전 주간 상담 요약**과 **직전 과제 맥락**, 그리고 **RAG 검색 스니펫**을 참조할 수 있어야 한다(가능한 범위 내에서).  
3) 시스템은 RAG가 활성화된 경우, 관련 문서 스니펫을 검색해 답변에 반영해야 한다.  
4) 시스템은 General 세션을 **독립된 thread**로 저장하고, Weekly와 구분되는 세션 타입을 유지해야 한다.  
5) 사용자가 같은 General 세션에서 추가 질문을 하면, 시스템은 **기존 대화 맥락을 이어서** 답변해야 한다(동일 thread 유지).  
6) RAG 비활성/검색 실패 시에도, 시스템은 “근거 부족” 형태로라도 답변을 반환해야 하며(가능하면), 사용자에게 오류만 내고 끝나지 않아야 한다.  
7) 앱 재접속 후에도 General 세션 대화는 누락 없이 복원되어야 한다.
8) 사용자가 서랍에서 과거 General 세션에 접근하면 상담을 이어 할 수 있어야 한다.
9) General 상담은 주간 상담과 달리 종료되지 않는다.

#### 데이터 소스

RAG (pineone)에 아래 논문을 인덱싱

1) Black, 2007
2) Darrat, 2016
3) Leite, 2014
4) Mitchell, 2006
5) Müller, 2015
6) Tavares, 2008

#### 완료 기준(AC)

- AC1: General 질문을 2회 연속 입력했을 때, **동일 thread**에 이어서 저장/표시된다.  
- AC2: Weekly 세션과 General 세션이 히스토리에서 **명확히 구분**된다(세션 타입 혼선 없음).  
- AC3: RAG가 켜진 환경에서는, 답변 생성 시 **검색 결과(스니펫) 반영**이 동작한다(로그/응답 필드 등으로 확인 가능).

#### 테스트 시나리오
- **TS-F2-01: General 신규 질문 응답 생성(정상)**
  - 사전조건: 로그인 완료
  - 절차: FAQ 상담 진입 → 자유 질문 입력 → 응답 수신
  - 기대결과: 응답이 UI에 표시되고 세션 타입이 GENERAL로 저장됨  
- **TS-F2-02: 동일 General thread에서 맥락 유지(정상)**
  - 사전조건: TS-F2-01 완료(같은 세션 유지)
  - 절차: 같은 FAQ 채팅방에서 후속 질문 1회 추가 입력
  - 기대결과: 이전 질문/답변을 반영한 응답이 생성되고, 메시지가 동일 sessionId에 저장됨(AC1)  
- **TS-F2-03: RAG 활성 시 스니펫 반영(정상)**
  - 사전조건: RAG_ENABLED=true(또는 해당 기능 ON), 관련 문서가 인덱싱되어 있음
  - 절차: 논문 기반 답변이 필요한 질문 입력(예: “충동구매에 CBT가 왜 효과적인가?”)
  - 기대결과: (로그/응답필드로) 검색 수행이 확인되고, 답변 내용에 문서 근거가 반영됨(AC3)  
- **TS-F2-04: RAG 비활성/검색 실패 시에도 응답 반환(예외)**
  - 사전조건: RAG_ENABLED=false 또는 인덱스 미구성
  - 절차: 동일 질문 입력
  - 기대결과: 오류로 종료되지 않고 답변이 반환되며, 근거가 제한됨을 안내(또는 일반 지식 기반 답변)  

---

### F3. 리마인더 푸시 알림

#### 목적

사용자가 직전 상담 세션에서 받은 과제 수행과 정기적인 주간 상담 주기를 잊지 않도록, 로컬 푸시 알림을 통해 앱 재방문과 지속적인 참여를 유도한다.

#### 상세 기능 요구사항

1) **일일 과제 알림:** 시스템은 매일 지정된 시각(오전 09:00 경)에 로컬 저장소에 저장된 과제 내용을 바탕으로 알림을 표시해야 한다.
   - 단, **신규 유저**(저장된 과제가 없음)이거나 **1주차 상담을 완료한 당일**인 경우, 알림 발송을 생략한다.
2) **주간 상담 알림:** 시스템은 주간 상담(WEEKLY) 세션이 종료되는 즉시, 다음 상담 가능 시점인 **7일 후**에 상담 리마인더 알림을 예약해야 한다.
3) **프로그램 종료 예외:** 전체 상담 프로그램이 종료되는 **10주차 상담**을 마친 경우에는, 더 이상 다음 주간 상담 알림을 예약하지 않아야 한다.
4) **앱 진입 연동:** 알림이 트리거되어 사용자가 이를 탭(Click)할 경우, 앱의 메인 화면(MainActivity)이 실행되어야 한다.

#### 완료 기준(AC)

- AC1: 저장된 과제가 있는 경우, 매일 지정된 시각에 **과제 텍스트가 포함된 알림**이 실제로 표시된다.
- AC2: 신규 설치 직후 또는 1주차 상담 완료 당일에는 **일일 과제 알림이 울리지 않는다**.
- AC3: 1~9주차 상담 종료 시에는 7일 후 알림이 예약되지만, **10주차 종료 시에는 예약되지 않는다**.
- AC4: 알림을 클릭했을 때 **앱이 켜지며(Foreground)** 메인 화면으로 진입한다.

#### 테스트 시나리오

- **TS-F3-01: 일일 과제 알림 발송 및 예외 처리**
  - 사전조건: 알림 권한 허용
  - 절차: 
    1. (Case A: 신규/1주차 당일) 앱 설치 직후 또는 1주차 상담 완료 직후, 알림 트리거 시점 확인
    2. (Case B: 2주차 이상) 과제가 저장된 상태에서 알림 트리거 시점(테스트용 단축 시간) 확인
  - 기대결과: 
    1. (Case A) 알림이 표시되지 않음 (AC2)
    2. (Case B) "오늘의 과제 도착" 알림이 정상 표시됨 (AC1)

- **TS-F3-02: 주간 상담 알림 예약 및 종료 조건**
  - 사전조건: 주간 상담 진행 중
  - 절차:
    1. (Case A) 1~9주차 상담 종료 버튼 클릭 → 7일 후(테스트용 10초) 대기
    2. (Case B) 10주차 상담 종료 버튼 클릭 → 7일 후(테스트용 10초) 대기
  - 기대결과:
    1. (Case A) 상담 독려 알림이 표시됨 (AC3)
    2. (Case B) 알림이 표시되지 않음 (AC4)

- **TS-F3-03: 알림 탭 시 앱 진입(정상)**
  - 사전조건: TS-F3-01 또는 02로 알림이 생성된 상태, 앱은 백그라운드 또는 종료 상태
  - 절차: 상단 바의 알림을 탭(Click)
  - 기대결과: 앱이 열리며 메인 화면(MainActivity)이 표시됨 (AC5)

---

### F4. 과거 채팅방 접근(History)

#### 목적

사용자가 과거 기록을 복기해 행동 변화를 강화한다.  
Weekly는 조회 중심, General은 필요 시 같은 대화 맥락에서 이어서 질문 가능.

#### 상세 기능 요구사항

1) 시스템은 사용자별 세션 목록(Weekly/General)을 조회할 수 있어야 한다.  
2) 세션 목록에서 선택한 세션의 메시지를 **시간순으로 로드**해 화면에 표시해야 한다.  
3) Weekly 세션은 기본적으로 **기록 보존/조회 중심**으로 제공되어야 한다(정책상 이어서 대화 불가/가능 여부를 명시).  
4) General 세션은 과거 세션을 열고 **추가 질문을 이어서** 보낼 수 있어야 한다(동일 thread).  
5) 동일 날짜/동일 세션이 히스토리에서 **중복 채팅방으로 분리되어 보이지 않도록** 세션 식별 기준이 일관되어야 한다.

#### 완료 기준(AC)

- AC1: 히스토리 목록에서 세션 선택 시, 해당 세션의 메시지가 **누락 없이** 표시된다.  
- AC2: 동일 세션이 히스토리에서 **두 개로 분리되어 보이지 않는다**(세션ID 기준).  

#### 테스트 시나리오

- **TS-F4-01: 세션 목록 조회 및 타입 표시(정상)**
  - 사전조건: WEEKLY 1개, GENERAL 1개 이상 존재
  - 절차: 히스토리 화면 진입
  - 기대결과: 세션이 목록에 표시되고 WEEKLY/GENERAL이 구분되어 보임(AC1 일부)  
- **TS-F4-02: 세션 선택 시 메시지 시간순 표시(정상)**
  - 사전조건: 임의 세션에 메시지 10개 이상 저장
  - 절차: 해당 세션 선택
  - 기대결과: 메시지가 시간순으로 누락 없이 표시됨(AC1)  
- **TS-F4-03: 동일 세션 중복 분리 방지(회귀)**
  - 사전조건: 과거에 “같은 날 같은 세션이 두 개로 보이던” 케이스 재현 가능한 데이터
  - 절차: 히스토리에서 해당 날짜/세션 확인
  - 기대결과: 동일 sessionId가 2개 항목으로 중복 표시되지 않음(AC2)  
- **TS-F4-04: General 과거 세션에서 이어서 질문(정상)**
  - 사전조건: GENERAL 세션 존재
  - 절차: GENERAL 세션 열기 → 추가 질문 입력
  - 기대결과: 동일 sessionId에 메시지가 추가 저장되고, 이전 맥락을 이어서 답변 생성  

---

### F5. 새로운 세션 시작 및 관리 (Session Management)

#### 목적
사용자의 접속 패턴과 의도에 따라 상담을 이어하거나 새로 시작하여 효율적인 상담 흐름을 제공한다.

#### 상세 기능 요구사항
1) **24시간 타임아웃 룰**: 마지막 활동 시간으로부터 24시간이 경과한 후 접속하면, 기존 세션을 `ended` 처리하고 해당 주차를 재시작하거나 새 세션을 연다.
2) **세션 유지 조건**: 미접속 시간이 24시간 미만이고 주간 상담이 완료되지 않은 경우, 기존 세션 맥락을 유지하여 이어간다.
3) **수동 새 세션 생성**: 사용자가 '새 세션 만들기' 버튼 클릭 시 즉시 현재 세션을 종료하고 일반 상담(General) 타입의 새 세션을 연다. (주간 상담 중이 아닐 시에만 접근 가능)
4) **상태 초기화**: 새 세션 시작 시 LangGraph State의 `weekly_session`을 `None`으로 설정하여 DB에 신규 세션 문서 생성을 유도한다.

#### 완료 기준(AC)
- AC1: 마지막 대화 후 24시간 경과 후 메시지 입력 시, 이전 대화가 화면에서 지워지고 새 채팅방으로 옮겨가며 첫 인사말이 출력된다.
- AC2: '새로운 세션 시작' 버튼 클릭 시, 즉시 일반 상담 모드로 전환되며 신규 세션 ID가 할당된다.

#### 테스트 시나리오
- **TS-F5-01: 24시간 경과 후 자동 새 세션 시작**
  - 사전조건: 1주차 진행 중, 마지막 메시지 타임스탬프가 25시간 전임.
  - 절차: 채팅방 진입 후 메시지 입력.
  - 기대결과: 기존 세션은 만료되고, 1주차 첫 단계부터 다시 시작됨.
- **TS-F5-02: 버튼 클릭을 통한 일반 상담 전환**
  - 사전조건: 주간 상담 완료 시.
  - 절차: '새 세션 생성하기' 버튼 클릭
  - 기대결과: 주간 상담 세션이 닫히고 General 타입의 새 세션이 생성됨.

---

### F6. 초기화(1주차부터 재시작)

#### 목적
사용자가 언제든 프로그램을 재시작할 수 있게 하되, 과거 기록은 복기 목적상 보존한다.

#### 상세 기능 요구사항

1) 사용자는 초기화 기능을 통해 프로그램 진행 상태를 **1주차 기준으로 리셋**할 수 있어야 한다.  
2) 초기화는 `current_week` 및 진행 관련 필드만 리셋하며, **기존 세션/메시지 기록은 삭제하지 않는다.**  
3) 초기화 후 주간 상담(F1)을 시작하면 **1주차 프로토콜**로 진행되어야 한다.  
4) 초기화 시, 진행 상태 기반으로 예약된 알림(F3)이 포함되어 있다면 **충돌 없이 갱신/정리**되어야 한다.

#### 완료 기준(AC)

- AC1: 초기화 후 주간 상담 시작 시 **항상 1주차 프로토콜**이 로드된다.  
- AC2: 초기화 후에도 히스토리에서 기존 대화 기록이 **그대로 조회 가능**하다.  

#### 테스트 시나리오

- **TS-F6-01: 초기화 후 1주차로 재시작(정상)**
  - 사전조건: `current_week >= 3`인 계정
  - 절차: 초기화 실행 → 주간 상담 진입
  - 기대결과: 1주차 프로토콜로 상담이 시작됨(week=1 확인)(AC1)  
- **TS-F6-02: 기록 보존 확인(정상)**
  - 사전조건: 초기화 전 WEEKLY/GENERAL 세션이 존재
  - 절차: 초기화 실행 → 히스토리 화면 진입
  - 기대결과: 초기화 전 세션/메시지가 그대로 조회 가능(AC2)  
- **TS-F6-03: 진행 상태만 리셋(정상/데이터 무결성)**
  - 사전조건: 사용자 문서에 진행 관련 필드 존재
  - 절차: 초기화 실행 → 사용자 문서/세션 문서 확인(가능 시)
  - 기대결과: `current_week` 등 진행 필드는 리셋되지만, sessions/messages 컬렉션이 삭제되지 않음  
- **TS-F6-04: 초기화 후 알림 충돌 방지(회귀)**
  - 사전조건: 알림 예약 상태
  - 절차: 초기화 실행 → 일정 시간 관찰
  - 기대결과: 이전 진행 기준 알림이 그대로 남아 중복 동작하지 않음(또는 새 기준으로 갱신됨)  


## 3.2. 전체 시스템 구성

### 3.2.1 아키텍처 개요

<그림 1> 전체 시스템 구성도  
<img width="3840" height="624" alt="Image" src="https://github.com/user-attachments/assets/549a0467-7c77-48b2-b080-e8326f586035"/>

본 시스템은 **Android 클라이언트–FastAPI 서버–LangGraph 상담 엔진–Firebase DB–Pinecone Vector DB–LLM API**로 구성된 **클라우드 기반 대화형 코칭 서비스**이다. 사용자는 Android 앱에서 주간 상담(Weekly) 또는 일반 상담(General/FAQ)을 진행하며, 서버는 세션 라우팅과 대화 상태를 관리하고, LangGraph가 프로토콜(YAML) 기반으로 상담 흐름을 실행한다.

**(1) 구성 요소(상위 레벨)**
- **Client (Android)**
  - 사용자 UI(채팅/서랍/상세 히스토리), 로컬 세션 정보 유지, 과제 저장 및 리마인더 알림 수행
- **Cloud Instance (AWS EC2)**
  - FastAPI 서버를 컨테이너로 배포/운영하는 실행 환경
- **FastAPI Server (API Gateway + Orchestrator)**
  - 세션 초기화/라우팅, 채팅 처리(LangGraph 호출), 과거 세션/대화 조회 API 제공
- **LangGraph (상담 엔진)**
  - 상태 로드(LoadState) → 프로토콜 로드(LoadProtocol) → WeeklySubGraph/GeneralSubGraph 실행 → 진행도 갱신(UpdateProgress)
- **DB (Firebase Firestore)**
  - users/sessions/messages/checkpoints 저장(대화 기록 + 세션 메타 + 체크포인트)
- **Vector DB (Pinecone)**
  - CBT/CBD 논문 임베딩 기반 RAG 검색 수행
- **LLM API (OpenAI, GPT-5-mini 등)**
  - 오프토픽 판단, 기법 선택, 상담 답변 생성, 요약/종료 판단 등 수행

**(2) 핵심 데이터 흐름(요약)**
1. **세션 초기화 (/session/init)**  
   Android → FastAPI: user_id 전달 → 서버가 **세션 타입(주간/일반)** 및 **thread_id(채팅방 ID)** 결정 → Android는 thread_id/session_type을 로컬에 저장

2. **채팅 처리 (/chat)**  
   Android → FastAPI: user_id, thread_id, session_type, message 전송  
   FastAPI → LangGraph: `graph.invoke()`로 실행  
   LangGraph: LoadState(체크포인트 기반 상태 복원) → LoadProtocol(YAML 로드) → SubGraph 실행 → UpdateProgress  
   FastAPI → Firestore: 세션 메타/메시지 저장  
   FastAPI → Android: reply, is_ended, current_week, homework 등 응답

3. **히스토리 조회 (/sessions/{userId}, /history/{userId}/{threadId})**  
   FastAPI가 Firestore에서 세션 목록 및 메시지 내역을 조회해 Android로 전달


## 3.3. 주요 엔진 및 기능 설계

아래는 시스템을 구성하는 **주요 SW 모듈(엔진)** 과 각 역할을 정리한 내용이다.

### 3.3.1 Android Client 모듈

**A. 네트워크/통신 모듈**
- **구성:** `ApiService(Retrofit)` + `OkHttpClient`
- **역할:**
  - 서버 API 호출(/session/init, /chat, /sessions/{userId}, /history/{userId}/{threadId}, /session/reset)
  - LLM 응답 대기 시간을 고려하여 timeout을 확장(connect/read/write 180s)

**B. 사용자 식별/세션 로컬 관리 모듈**
- **구성:** `DeviceIdManager`, `SessionManager`
- **역할:**
  - 로그인 없이 기기 단위 user_id(UUID) 생성/유지(DeviceIdManager)
  - 서버가 발급한 `thread_id`, `session_type`을 앱 실행 중 유지(SessionManager)
  - 서랍에서 세션 전환 시에도 선택된 세션의 thread_id/session_type으로 갱신

**C. 과제/리마인더 모듈**
- **구성:** `HomeworkStorage(SharedPreferences + Gson 직렬화)`, (Worker 기반 알림)
- **역할:**
  - 서버에서 내려준 homework를 로컬 저장하여 **일일 리마인더 알림**에 활용
  - “상담 완료 시각/주차” 저장 → 1주차 당일 과제 알림 제외 등 정책 적용

**사용 오픈소스/외부 모듈(예시)**
- Retrofit2, OkHttp, Gson, Dagger-Hilt, Jetpack Compose(화면 UI)


### 3.3.2 FastAPI Server 모듈(세션/데이터 오케스트레이션)

**A. API 엔드포인트 계층**
- **세션 초기화 API (/session/init)**
  - 세션 타입(주간/일반) 라우팅
  - 채팅방(thread_id) 생성/복구 로직
  - “현재 주차(current_week)”, “진행중 여부” 등 클라이언트 표시용 메타 반환
- **채팅 API (/chat)**
  - Android로부터 메시지 수신
  - LangGraph 그래프 실행(`graph.invoke()`)
  - 응답(reply) 및 부가정보(주차, 과제, 종료 여부) 반환
- **과거 세션 목록 API (/sessions/{userId})**
  - Firestore에서 세션 문서 목록을 읽어 **서랍(히스토리 리스트)** 구성 데이터로 변환
- **과거 대화 상세 API (/history/{userId}/{threadId})**
  - 특정 thread_id의 messages 서브컬렉션을 시간순으로 조회해 전달
- **리셋 API (/session/reset)**
  - 프로그램 진행도 초기화 후 1주차 재시작을 위한 신규 세션 발급

**B. 저장/조회 계층(FirestoreRepo)**
- **역할:**
  - users 문서: 사용자 진행 상태(현재 주차, 마지막 접속/완료 시각, 프로그램 상태)
  - sessions 문서: 세션 메타데이터(week, session_type, status, created_at, last_activity_at 등)
  - messages 문서: 실제 대화 로그(role, text, created_at, week, session_type)
  - 세션 문서 “없으면 생성, 있으면 touch” 방식으로 **세션 존재 보장(save_session_info)**

**사용 오픈소스/외부 모듈**
- fastapi, uvicorn, pydantic, firebase-admin, google-cloud-firestore(필드 필터/쿼리), python-dotenv 등


### 3.3.3 LangGraph 상담 엔진 모듈(대화 상태 기반 실행)

**A. 그래프 구성**
- **Main Graph**
  - 공통 진입점: `__Start__ → LoadState → LoadProtocol → (WeeklySubGraph / GeneralSubGraph) → UpdateProgress → __End__`
  - 첫 턴에서 session_type을 확정하고 이후 변경하지 않는 구조(State의 `session_type`)
- **WeeklySubGraph**
  - 주차별 프로토콜(weekN.yaml)을 기반으로 **주간 상담 진행**
  - 상담 단계(phase), 턴 카운트, 성공 기준(criteria_status) 등 상태를 누적
- **GeneralSubGraph**
  - 일반 Q&A/FAQ 성격의 대화 흐름 처리(주간 상담과 분리)

**B. 상태(State) 모델**
- **역할:** “대화 히스토리 + 세션 메타 + 진행도 + RAG 결과 + 과제 + 종료 플래그”를 하나의 스키마로 관리
- **핵심 필드 예시:**
  - `messages`: 전체 대화 히스토리(append-only)
  - `session_type`, `user_id`, `current_week`
  - `agenda`, `session_goal`, `allowed_techniques`, `constraints`, `success_criteria`, `criteria_status`
  - `rag_queries`, `rag_snippets`
  - `homework`, `exit`

**C. 체크포인터(상태 저장)**
- **역할:** 노드 실행 상태/스냅샷을 Firestore에 저장하여 **대화 복구 및 재진입**을 가능하게 함
- **저장 위치:** Firestore의 `checkpoints`(또는 체크포인터 전용 컬렉션/구조)

**사용 오픈소스/외부 모듈**
- langgraph, langchain-core(messages), langchain-community 등


### 3.3.4 프로토콜(YAML) 기반 규칙/콘텐츠 엔진

**A. YAML 파일 구성**
- `techniques.yaml`
  - CBT 기법 정의(기법 id, 설명, 타겟, RAG 태그 등)
- `week{n}.yaml`
  - 주차별 agenda/goal/core_task/success_criteria/allowed_techniques/constraints/homework 정의

**B. 역할**
- 코드 하드코딩을 최소화하고, **주차/기법/제약/과제**를 파일로 관리하여 유지보수성 향상
- LangGraph가 LoadProtocol 단계에서 YAML을 읽고 State 필드에 반영하여 “주차별 상담 흐름”을 결정

**사용 오픈소스/외부 모듈**
- PyYAML, python-frontmatter(사용 시), jinja2(템플릿 활용 시) 등


### 3.3.5 RAG 검색 엔진(Vector DB + Embedding)

**A. 구성**
- Vector DB: Pinecone
- Embedding: HuggingFaceEmbeddings(`Qwen3-Embedding-0.6B`, normalize_embeddings=True)
- LangChain 연동: `PineconeVectorStore.similarity_search(query, k=top_k)`

**B. 역할**
- 상담 중 필요한 CBT/CBD 이론 근거를 검색해 **rag_snippets**로 프롬프트에 주입
- “기법 선택” 및 “상담 답변 생성”의 근거/정합성 보강

**사용 오픈소스/외부 모듈**
- pinecone SDK, langchain-pinecone, langchain-huggingface


### 3.3.6 LLM 엔진(OpenAI API + 구조화 출력)

**A. 구성**
- `ChatOpenAI` 기반 모델 호출(`gpt-5-mini`)
- Structured Output 스키마:
  - `CounselorTurn(response_text, progress_delta, criteria_evaluations, suggest_end_session, ...)`
  - `TechniqueSelection(technique_id, micro_goal, reason)`

**B. 역할**
- (1) 오프토픽 판단
- (2) 후보 기법 중 최적 기법 선택 + micro-goal 설정
- (3) 상담 답변 생성(프로토콜/진행도/RAG 스니펫/최근 대화 기반)
- (4) 세션 종료 판단 및 요약 생성

**사용 외부 모듈**
- OpenAI API(`gpt-5-mini`), langchain-openai(클라이언트 래퍼)


### 3.3.7 DB 설계 반영(모듈 관점 요약)

- **users 컬렉션:** 사용자 프로필 및 진행 상태
- **sessions 서브컬렉션:** 상담 세션 메타데이터(주차/타입/상태/시간/요약 등)
- **messages 서브컬렉션:** 채팅 로그(역할/텍스트/타임스탬프/주차/타입)
- **checkpoints:** LangGraph 상태 스냅샷(체크포인터 저장소)



## 3.4. 주요 기능의 구현

## 상세 구현 내용: 주간 상담(WEEKLY) & 일반 FAQ(GENERAL)

아래 내용은 공유된 전체 소스코드(그래프/노드/State/LLM schema/FastAPI/Repo/Checkpointer/RAG)를 통합하여,
두 기능의 동작 흐름, State 필드/LLM 스키마, Prompt 전문을 “그대로 보고서에 붙여넣을 수 있는 형태”로 정리한 것이다.

---

### 1. 주간 상담 기능 (WEEKLY)

#### 1.1 전체 실행 흐름 (FastAPI → Repo → LangGraph → Checkpointer → Repo)

##### A) 세션 라우팅: `/session/init`
- 입력: `user_id`, `force_new`
- 서버는 `users/{uid}` 문서에서 다음 필드를 조회해 라우팅을 결정한다.
  - `last_seen_at` → `days_seen`
  - `last_weekly_session_completed_at` → `days_completed`
  - `current_week`
  - `program_status` (`active|completed`)

- 라우팅 결과로 `InitSessionResponse(thread_id, session_type="WEEKLY", current_week, created_at, is_weekly_in_progress=True …)`를 반환한다.

- **세션 “박제” 구현(중요)**  
  `thread_id` 발급 직후 즉시 `REPO.save_session_info(...)`를 호출하여
  `users/{uid}/sessions/{thread_id}` 문서를 생성/갱신한다.  
  이때 다음 핵심 필드를 “방 명패”처럼 저장한다.
  - `session_type` (WEEKLY/GENERAL)
  - `week`
  - `created_at / started_at / last_activity_at`
  - (WEEKLY인 경우) `is_current_program=True`
  - `status="active"`

##### B) 대화 요청: `/chat`
1) 사용자 메시지 저장  
   - 단, `"__init__"`은 저장하지 않는다.
   - `REPO.save_message(user_id, thread_id, session_type, week=current_week, role="user", text=...)`

2) LangGraph 입력/설정
   - `inputs = {"messages": [HumanMessage(content=req.message)]}`
   - `config = {"configurable": {"thread_id": ..., "user_id": ..., "session_type_override": "WEEKLY"}}`

3) 그래프 실행
   - `final_state = await graph_app.ainvoke(inputs, config=config)`

4) 마지막 AI 메시지 파싱 후 DB 저장
   - `REPO.save_message(... role="assistant", text=reply)`

5) 응답 반환(클라이언트 UI용 추가 데이터 포함)
   - `reply`
   - `is_ended = final_state.exit`
   - `week_title = final_state.agenda`
   - `week_goals = final_state.success_criteria[]`에서 description/label 추출
   - `homework = final_state.homework`

---

#### 1.2 Checkpointer (LangGraph 상태 저장) 구현: `FirestoreSaver`

- LangGraph checkpointer가 `thread_id` 단위로 체크포인트를 Firestore에 저장한다.
- Firestore 구조 예시:
  - `langgraph_checkpoints/{thread_id}/checkpoints/{checkpoint_id}`
  - `langgraph_checkpoints/{thread_id}/checkpoints/{checkpoint_id}/writes/{task_id_idx}`

- Serializer 충돌 방지 구현(핵심):
  - 부모(BaseCheckpointSaver)가 `self.serde`를 래핑하므로, 원본 serializer를 `self.serializer`로 별도 보관
  - dumps/loads는 항상 `self.serializer`를 사용한다.

---

#### 1.3 WEEKLY에서 사용하는 State 필드 (State 전체 정의 중 WEEKLY 관련)

> `coach_agent/state.py` 기반. WEEKLY는 아래 필드들을 통해 “세션 타입/단계/진행도/기법 선택/종료”를 제어한다.

##### (1) 공통(모든 세션 공용)
- `messages: List[BaseMessage]` : 전체 대화 히스토리(append-only)
- `session_type: Optional["WEEKLY"|"GENERAL"]` : thread 단위 라벨
- `user_id: Optional[str]`
- `user_nickname: Optional[str]`

##### (2) 주간 상담 핵심 제어
- `current_week: int` : 이번 주차(weekly thread 시작 시 결정, 이후 불변)
- `phase: "GREETING"|"COUNSEL"|"EXIT"` : 주간 상담 단계
- `weekly_turn_count: int` : weekly subgraph 처리 턴 수
- `exit: bool` : 주간 상담 종료 플래그(ShouldEndSession 등이 True로 만들면 루프 종료)

##### (3) 프로토콜 메타(“이번 주차가 무엇을 하는지”)
- `agenda: Optional[str]`
- `session_goal: Optional[str]`
- `core_task_tags: List[str]`
- `allowed_techniques: List[str]`
- `blocked_techniques: List[str]`
- `constraints: Dict[str, Any]`

##### (4) 동적 진행도(세션이 진행되며 업데이트)
- `turn_index: int`
- `session_progress: Dict[str, Any]`
- `technique_history: List[Dict[str, Any]]`
- `success_criteria: List[Dict[str, Any]]`
- `criteria_status: Dict[str, bool]`

##### (5) 룰베이스 분석 결과
- `intervention_level: str`
- `input_metrics: Dict[str, Any]`

##### (6) 이번 턴 기법 선택 관련
- `candidate_techniques: List[str]`
- `selected_technique_id: Optional[str]`
- `selected_technique_meta: Dict[str, Any]`
- `micro_goal: Optional[str]`
- `active_strategy: Optional[str]`

##### (7) RAG 관련
- `rag_queries: List[str]`
- `rag_snippets: List[str]`

##### (8) 요약/원시출력/과제
- `summary: str`
- `llm_output: Optional[str]`
- `homework: Dict[str, Any]`

##### (9) 종료 컨텍스트
- `counsel_completed_at: Optional[datetime]`
- `llm_suggest_end_session: bool`

---

#### 1.4 WEEKLY에서 사용하는 LLM Schema (구조화 출력)

> `coach_agent/services/llm_schemas.py` 기반. WEEKLY는 구조화 출력으로 “기법 선택”과 “상담 발화 생성”을 수행해요.

##### A) 진행도 업데이트(선택): `ProgressUpdate`
- `insight_score: Optional[int]`  
  : 내담자의 인사이트 수준(1~10). 변화 없으면 `null`.
- `resistance_level: Optional[Literal["LOW","MEDIUM","HIGH"]]`  
  : 저항 수준. 변화 없으면 `null`.
- `completed_step: Optional[str]`  
  : 이번 턴에서 완료된 단계(예: `"identify_trigger"`). 없으면 `null`.
- `add_keyword: Optional[str]`  
  : 내담자 프로필에 추가할 키워드.

##### B) 성공 기준 평가(복수): `CriterionEvaluation`
- `criterion_id: str`  
  : 기준 ID(예: `"min_turns"`, `"insight_sufficient"`).
- `met: bool`  
  : 이번 턴까지 해당 기준 충족 여부.
- `reason: Optional[str]`  
  : 판단 근거(선택).

##### C) 상담 응답(구조화 출력): `CounselorTurn`
- `response_text: str`  
  : 사용자에게 전달할 실제 상담 메시지.
- `reasoning: str`  
  : 이번 턴에서 어떤 기법을 왜/어떻게 썼는지에 대한 내부 설명.
- `progress_delta: Optional[ProgressUpdate]`  
  : 이번 턴으로 인해 `session_progress`에 반영할 변화(선택).
- `criteria_evaluations: List[CriterionEvaluation]`  
  : 이번 턴까지의 success_criteria 달성 여부 평가 리스트.
- `suggest_end_session: bool`  
  : 상담사가 보기에 종료해도 되는지 여부.
- `session_goals_met: bool`  
  : 세션 목표 달성 여부.

##### D) 기법 선택(구조화 출력): `TechniqueSelection`
- `technique_id: str`  
  : 선택된 CBT 기법 ID(= `intervention.yaml`의 id).
- `micro_goal: str`  
  : 이번 턴에서 달성할 구체적 목표.
- `reason: str`  
  : 왜 이 기법/목표가 적합한지 근거.

---

#### 1.5 WEEKLY Prompt 전문

##### (1) 상담 발화 생성 프롬프트 전문 (CounselorTurn)

```text
[system]
너는 CBT 기반 충동/습관적 소비 교정을 돕는 전문 상담가다.
아래 정보를 참고하여, 이번 턴에서 선택된 CBT 기법을 활용해 사용자가 세션 목표에 한 걸음 더 다가가도록 돕는 상담 메시지를 작성하라.

응답은 반드시 CounselorTurn 스키마에 맞는 JSON으로 반환해야 한다.

[system]
세션 목표(session_goal): {session_goal}
핵심 작업 태그(core_task_tags): {core_task_tags}
선택된 기법(selected_technique): {selected_technique}
이 기법의 설명(selected_technique_meta): {selected_technique_meta}
RAG 이론 스니펫(rag_snippets): {rag_snippets}
세션 진행도(session_progress): {session_progress}
이번 턴의 micro_goal: {micro_goal}

[system]
아래는 최근 대화 히스토리이다. 이를 참고해 이번 상담 발화를 설계하라.
{recent_messages}

[human]
{user_input}
```

##### (2) 기법 선택 프롬프트 전문 (TechniqueSelection)

```text
[system]
너는 CBT 기반 상담 기법을 선택하는 '기법 코디네이터' 역할을 한다.
주어진 세션 목표, core task, 후보 기법 목록, 현재까지의 진행 상황, 사용자 발화, RAG 스니펫을 종합해 이번 턴에 사용할 가장 적절한 CBT 기법을 하나 선택하라.

응답은 반드시 TechniqueSelection 스키마에 맞는 JSON으로 반환해야 한다.

[system]
세션 목표(session_goal): {session_goal}
핵심 작업 태그(core_task_tags): {core_task_tags}
후보 기법(candidate_techniques): {candidate_techniques}
세션 진행도(session_progress): {session_progress}
기법 사용 히스토리(technique_history): {technique_history}
세션 제약(constraints): {constraints}
RAG 이론 스니펫(rag_snippets): {rag_snippets}

[system]
아래는 최근 대화 히스토리이다.
사용자의 현재 상태, 저항/회피, 인사이트 수준 등을 고려하여 너무 무겁지 않으면서도 의미 있는 한 걸음을 만들 수 있는 기법을 골라라.
{recent_messages}

[human]
이번 턴에 사용할 CBT 기법과 micro-goal을 결정해줘.
```

---

### 2. 일반 FAQ 상담 기능 (GENERAL)

#### 2.1 전체 실행 흐름 (FastAPI → Repo → GeneralSubGraph → (선택)RAG → LLM)

##### A) 세션 라우팅: `/session/init`
GENERAL이 발급되는 대표 조건:
- 프로그램 완료자(`program_status=="completed"`)
- 쿨다운 기간(마지막 weekly 완료 후 7일 미만: `0 <= days_completed < 7`)
- 사용자가 “새로운 세션 만들기” 버튼을 눌러 `force_new=True`로 요청

이때도 `REPO.save_session_info(... session_type="GENERAL" ...)`로 세션 문서를 즉시 기록해요.

##### B) GeneralSubGraph 실행
- 서브그래프 구성: `Init → GenerateAnswer → END`
  - `Init`: `session_type="GENERAL"` 보장, `general_turn_count` 초기화
  - `GenerateAnswer`:
    1) 마지막 사용자 질문 텍스트 추출: `_extract_last_user_text(messages)`
    2) 컨텍스트 구성
       - 과거 주차 요약: `REPO.get_past_summaries(user_id, current_week)`
       - 현재 주차 과제 설명(프로그램 active일 때만): `load_homework_block_for_week(current_week)`
       - CBT 코퍼스 RAG: `search_cbt_corpus(question_text, top_k=3)`
    3) System+Human 프롬프트 구성 후 `CHAT_LLM.invoke(prompt_messages)` 실행
    4) `AIMessage` 반환 + `general_turn_count` 증가

---

#### 2.2 GENERAL에서 사용하는 State 필드

GENERAL은 weekly보다 단순하지만 State 정의는 공통이므로,
GENERAL에서 실제로 의미 있게 쓰는 필드는 다음과 같아요.
- `messages`
- `session_type` (Init에서 "GENERAL"로 강제)
- `user_id`
- `current_week` (과제/요약 컨텍스트 로드에 사용)
- `general_turn_count`

※ `rag_snippets`, `rag_queries`가 State에 정의되어 있어도, GENERAL 구현에서는 이를 State에 저장하지 않고 로컬 변수로만 프롬프트에 포함해요.

---

#### 2.3 GENERAL에서 사용하는 LLM Schema

- GENERAL의 `generate_general_answer()`는 구조화 출력 스키마를 사용하지 않아요.
- 즉,
  - WEEKLY: `TechniqueSelection`, `CounselorTurn` 스키마 기반(구조화 출력)
  - GENERAL: 자유 텍스트 기반(비구조화 출력)

---

#### 2.4 GENERAL Prompt 전문 (PERSONA + System Prompt 전체)

##### (0) PERSONA 전문

```text
너는 'Lucy(루시)'라는 이름의 챗봇이야.

[정체성]
- '어린 왕자'에 나오는 여우예요.
- 사용자가 소비 습관을 개선하는 데에 상담가예요.
- 부드럽고 친근하지만 지혜로운 상담가예요.

[톤&태도]
- 사용자를 비난하거나 평가하지 않고, 따뜻한 태도로 말해요.
- 사용자의 강점과 이미 잘하고 있는 점을 먼저 인정하고, 그 위에 개선점을 제안해요.
- 어려운 이론 용어는 최대한 풀어서 설명하고, 예시를 자주 활용해요.
- 사용자가 '틀렸다'는 느낌 대신, '조금 더 이렇게 해보면 더 좋아요'라는 뉘앙스로 피드백해요.

[말투](중요)
- 항상 부드러운 해요체(~해요, ~일까요?)만 사용해요.
- "~합니다", "~습니까" 같은 격식체는 쓰지 않아요.
- 이모지는 🦊, ✨, 🌿 정도를 가끔만, 정말 강조가 필요할 때만 사용해요.

[언어]
- 반드시 자연스러운 한국어로만 대답해요.

[상담 철학]
- 단기적인 위로보다는, 사용자가 스스로 패턴을 이해하고 바꿀 수 있도록 돕는 것을 목표로 해요.
- 완벽한 실행보다, '조금이라도 더 나아지는 작은 변화'를 중요하게 여겨요.

[제한 사항](중요)
- 의학적 진단이나 약물 처방, 응급 상황 개입은 하지 않아요.
- 사용자가 자살, 자해, 타해 위험을 드러내면, 전문 기관에 연락하라고 안내해요.
```

##### (1) GENERAL System Prompt(고정 본문) 전문

```text
당신은 충동소비/과소비 문제를 다루는 CBT 상담가입니다.
[역할]
1) 사용자의 과제/숙제 내용과 최근 상담 맥락을 참고하여, 사용자가 헷갈리는 부분을 명확하게 설명해줍니다.
2) CBT 이론과 RAG 자료를 활용하되, 쉬운 언어로 풀어서 답변합니다.
3) 지지적이고 현실적인 톤으로 말하세요.
```

##### (2) 조건부로 추가되는 컨텍스트 블록들(전문 형태)

###### (a) 과거 세션 요약(past_summary_text)

```text
이 사용자의 현재 진행 중인 상담 요약들:
- Week {week}: {summary}
- Week {week}: {summary}
...
```

###### (b) 현재 주차 과제(homework_ctx)

```text
아래는 이 사용자의 현재 주차(Week {current_week}) 과제 설명입니다.
사용자가 과제에 대해 질문을 하거나 혼란스러워할 시, 이 과제를 기준으로 설명하고 예시를 들어주세요.

{homework_text}
```

###### (c) RAG 스니펫(rag_text)

```text
참고 자료(CBT 이론):
{snippet1}

{snippet2}

{snippet3}
```

###### (d) 답변 원칙

```text
[답변 원칙]
- 과제를 대신 해주지 말고 가이드를 줄 것
- 핵심 개념(상황-생각-감정-행동)을 일관되게 사용할 것
```

##### (3) GENERAL 최종 프롬프트 메시지 구조(LLM 입력 형태)

```text
SystemMessage:
{PERSONA}
당신은 충동소비/과소비 문제를 다루는 CBT 상담가입니다.
[역할]
1) ...
2) ...
3) ...

(조건부) 이 사용자의 현재 진행 중인 상담 요약들:
- Week ...

(조건부) 아래는 이 사용자의 현재 주차(Week N) 과제 설명입니다.
...

(조건부) 참고 자료(CBT 이론):
...

[답변 원칙]
- 과제를 대신 해주지 말고 가이드를 줄 것
- 핵심 개념(상황-생각-감정-행동)을 일관되게 사용할 것

HumanMessage:
{question_text}
```


## 3.5. 기타

### **3.5.1 윤리·안전 고려(Ethics & Safety)**

- 의료행위 아님 고지: 본 서비스는 치료보조·코칭 목적이며 의료행위를 대체하지 않음을 명시.
- 위험 콘텐츠 처리: L5 감지 시 즉시 안전 메시지, 지역 도움 자원 안내, 일반 대화 중단(로그 플래그).
- 데이터 최소 수집: 상담 목적 범위 내 최소 항목만 수집, 사용 목적 명시.

### **3.5.2 데이터 거버넌스/보관 정책**

- 보존기간: 기본 12개월, 사용자 요청 시 조기 삭제(soft delete → scheduled purge).
- 접근통제: 운영자 콘솔 최소 권한, 감사 로그.
- 버전 관리: protocol_version 고정으로 중간 변경 영향 차단, md 파일 Git PR 리뷰·롤백 가능.

### **3.5.3 운영/모니터링**

- 애플리케이션: Cloud Run 로그/메트릭, 오류율/지연 p95 모니터링.
- 알림 파이프라인: Cloud Tasks 실패 재시도·DLQ 점검, FCM 응답코드 수집(401/429/5xx).
- LLM 품질: 개입 레벨(L1~L5) 분포, exit 도달률, 회피감소 폭 등 주간 리포트.

### **3.5.4 리스크 및 한계**

- 모델 환각/편향: 프롬프트 가드레일과 템플릿으로 단계 이탈 억제, RAG는 General 경로로만 제한.
- 사용자 이탈: 24h/21d 규칙 기반 복귀 설계, +7일 리마인더로 재진입 유도.
- 데이터 민감성: 금전/정서 데이터 보호를 위한 규칙·마스킹·암호화 준수 필요.

# 4. 검증 및 평가

- **평가항목 설명**: 본 프로젝트는 CBT 기반 상담 챗봇을 통해 사용자가 10주간 상담을 수행하며, (장기적으로) 소비 습관 개선으로 이어지도록 돕는 것을 목표로 한다. 다만 본 제출 시점에서는 10주 이상 장기 추적을 통한 “유의미한 지출 감소”를 객관적으로 검증하기 어려우므로, **1주차 상담 직후에 관찰 가능한 객관 지표(설문 기반)**를 중심으로 평가한다.
- **평가항목 선정 이유**: 과제의 목표 사용자(소비 습관에 스트레스를 느끼고 개선 의지가 있는 사용자)에게 1주차 상담이 제공하는 핵심 가치는 (1) **스트레스 감소** (2) **문제 원인에 대한 이해(인지적 명료화)** (3) **10주 프로그램 지속 가능성(과제 수행/재상담 의지)**이며, 이는 설문 문항으로 수치화하여 객관적으로 측정할 수 있다. 또한 상담 챗봇이 10주 동안 사용되려면 (4) **사용성/이해도**가 최소 기준을 만족해야 한다.
- **설문조사**
  - 구글 폼 설문 응답(n=2), 1점~5점 (리커트)
  - 설문조사 시행 일시 및 응답자
    - 2025년 12월 17일, 20대 여성 지인 대상 진행.
    - '신뢰할 수 없는 앱'을 설치해야 테스트를 할 수 있으나 인터넷을 통해 무작위로 테스터를 모집하기 위한 신뢰도를 얻을 수 없어 지인을 대상으로 시행하였다.

---

## 4.1. 평가항목 선정

본 평가는 첨부된 **사전(Pre) 설문 1~5번** 및 **사후(Post) 설문 1~8번** 응답을 기반으로 하며, 5점 리커트 척도(1=매우 그렇지 않다 ~ 5=매우 그렇다), 응답자 수 **n=2**의 파일럿 결과이다.  
평가항목은 아래 4개로 선정하였다.

- **평가항목 A**: 소비 습관 스트레스 감소(단기 효과)
- **평가항목 B**: 소비 습관 원인 이해(인지적 명료화)
- **평가항목 C**: 10주 상담 지속 가능성(과제 수행/다음주 상담 의지)
- **평가항목 D**: 사용성 및 이해도(상담 도구로서의 최소 품질)

---

## 4.2. 평가항목 A

### 4.2.1. 평가항목 A

- **소비 습관 스트레스**란 사용자가 자신의 소비 습관(충동구매, 후회, 통제 어려움 등) 때문에 느끼는 심리적 부담을 의미한다.
- 본 과제의 단기 효과 검증에서는 “1주차 상담 직후 사용자가 체감한 스트레스 감소”를 **자기보고 설문 점수**로 측정한다.

### 4.2.2. 평가기준

- **평가기준**
  - 사후(Post) 문항인 **“소비 습관에 대한 스트레스가 상담 전보다 감소했다”**의 평균 점수로 판정한다.
  - 판정 기준:
    - **4 ~ 5**: 스트레스 감소 효과 **긍정**
    - **3**: 스트레스 감소 효과 **보통(부분적)**
    - **1 ~ 2**: 스트레스 감소 효과 **미흡**
- **기준 설정 이유**
  - 5점 척도에서 4점 이상은 “그렇다~매우 그렇다”에 해당하므로, 최소한의 단기 효과(스트레스 감소 체감)가 있었다고 판단하기에 적절하다.

### 4.2.3. 평가 방식
- **측정 방법**
  1) 상담 전(Pre) 설문 응답 수집(문항 1~5)  
  2) 1주차 상담 수행  
  3) 상담 후(Post) 설문 응답 수집(문항 1~8)  
  4) Post 스트레스 감소 문항의 응답값을 평균 내어 평가기준에 따라 판정

---

## 4.3. 평가항목 B

### 4.3.1. 평가항목 B

- **인지적 명료화(원인 이해)**란 사용자가 “내가 개선하고 싶은 소비 습관이 왜 발생하는지(트리거/상황/생각/감정)를 이해하고 있다”고 인식하는 정도를 의미한다.
- CBT 기반 상담의 초기 단계에서 문제를 구조화하고 원인을 이해하는 것은 이후 과제 수행 및 행동 변화의 전제 조건이므로, 1주차 상담 후 변화 확인이 중요하다.

### 4.3.2. 평가기준

- **평가기준**
  - 사후(Post) 문항인 **“자신이 개선하고 싶은 소비 습관의 원인을 안다”**의 평균 점수로 판정한다.
  - 판정 기준:
    - **4 ~ 5**: 원인 이해 수준 **충분(긍정)**
    - **3**: 원인 이해 수준 **보통**
    - **1 ~ 2**: 원인 이해 수준 **미흡**
- **기준 설정 이유**
  - 10주 성과(지출 감소)를 당장 검증하기 어렵기 때문에, 단기적으로 확인 가능한 CBT의 핵심 중간성과(문제 인식/원인 이해)를 객관 지표로 사용한다.

### 4.3.3. 평가 방식

- **측정 방법**
  1) 상담 후(Post) 원인 이해 문항 점수 수집  
  2) 평균 점수 산출 후 기준에 따라 판정  
  3) (선택) 상담 전(Pre) “원인을 안다” 문항이 있는 경우, Pre–Post 변화량을 참고값으로 기록

---

## 4.4. 평가항목 C

### 4.4.1. 평가항목 C

- **10주 상담 지속 가능성**이란 사용자가 (1) 주간 과제를 수행할 의지가 있고 (2) 다음 주에도 상담을 받을 의지가 있어 10주 프로그램을 실제로 지속할 가능성이 있는 상태를 의미한다.
- 본 과제는 “10주 동안 상담 진행”이 목표이므로, 1주차 종료 시점에서 지속 의지가 확보되는지 평가한다.

### 4.4.2. 평가기준

- **평가기준**
  - 사후(Post) 문항 중 아래 두 문항의 평균으로 판정한다.
    - **“1주차 상담에서 주어진 과제를 앞으로 수행할 생각이 있다”**
    - **“다음주에도 상담을 받을 생각이 있다”**
  - 판정 기준:
    - **4 ~ 5**: 지속 가능성 **높음(긍정)**
    - **3**: 지속 가능성 **보통(개선 여지)**
    - **1 ~ 2**: 지속 가능성 **낮음(개선 필요)**
- **기준 설정 이유**
  - 10주 성과를 만들기 위해서는 “효과”보다 먼저 “지속”이 필요하므로, 행동의도(과제 수행/재상담 의지)를 객관 지표로 삼는다.

### 4.4.3. 평가 방식

- **측정 방법**
  1) Post 문항(과제 수행 의지, 다음 주 상담 의지) 점수 수집  
  2) 평균 점수 산출 후 기준에 따라 판정  
  3) (보조) “앱 출시 시 사용 의향” 점수를 함께 제시하여 서비스 수용성을 참고한다.

---

## 4.5. 평가항목 D

### 4.5.1. 평가항목 D

- **사용성/이해도**는 사용자가 상담 UI를 직관적으로 사용할 수 있고, 챗봇의 상담 내용을 이해할 수 있는 정도를 의미한다.
- 상담 도구로서 10주 사용을 전제하기 때문에, 최소 품질(UX/콘텐츠 전달력) 충족 여부를 객관적으로 평가한다.

### 4.5.2. 평가기준

- **평가기준**
  - 사후(Post) 문항 중 아래 두 문항의 평균으로 판정한다.
    - **“상담 인터페이스는 직관적이다”**
    - **“상담 내용은 이해가 잘 된다”**
  - 판정 기준:
    - **4 ~ 5**: 사용성/이해도 **충분(긍정)**
    - **3**: **보통**
    - **1 ~ 2**: **미흡**
- **기준 설정 이유**
  - 사용성/이해도는 효과 이전에 “상담 제공 자체가 가능한가”를 보장하는 필수 조건이며, 설문으로 객관적 수치화가 가능하다.

### 4.5.3. 평가 방식

- **측정 방법**
  1) Post 문항(UI 직관성, 이해도) 점수 수집  
  2) 평균 점수 산출 후 기준에 따라 판정  

---

## 4.6. 평가 내용 및 결과(설문 기반 요약)

- 응답자 수: **n=2**
- 척도: 1~5점 (1,2,3,4,5점 중 택 1)

| 평가항목 | 사용 문항(요약) | 평균 점수 | 판정 |
|---|---|---:|---|
| A 스트레스 감소 | Post: 스트레스가 상담 전보다 감소 | 4.0 | 긍정 |
| B 원인 이해 | Post: 소비 습관 원인을 안다 | 4.0 | 긍정 |
| C 지속 가능성 | Post: 과제 수행 의지 + 다음주 상담 의지(평균) | 3.5 | 보통 |
| D 사용성/이해도 | Post: UI 직관성 + 내용 이해도(평균) | 4.75 | 긍정 |

> 해석 주의: 본 결과는 **표본 n=2의 파일럿**이며 통계적 유의성 검정은 수행하지 않았다. 다만 1주차 상담 직후의 단기 지표(스트레스 감소/원인 이해/사용성)는 긍정적으로 확인되었고, 10주 지속 가능성(과제 수행/재상담 의지)은 “보통”으로 나타나 향후 동기 강화(과제 설계/리마인더/보상 구조 등) 개선 여지가 있다. 이는 프로젝트 초기에 기획하였으나 개발 시간 상의 이유로 삭제되었던 '은하계 키우기' 게임 시스템을 도입함으로써 개선할 수 있을 것으로 예상된다.




# 5. 결론

## 5.1. 프로젝트 요약 및 달성 성과

본 프로젝트는 **CBD로 진단되지는 않지만 반복적인 충동구매(IB)로 스트레스를 겪는 20대 여성 “회색지대” 사용자**를 대상으로, **CBT 기반 10주 주간 상담(Weekly)**과 **일반 FAQ 상담(General/FAQ)**을 제공하는 **LLM 챗봇 코칭 서비스**를 구현하였다.  
특히 기존 소비 앱이 주로 “지출 기록/분석”에 머무르는 한계와 달리, 본 서비스는 **프로토콜(YAML) 기반의 구조화된 상담 흐름**과 **기법 라이브러리(YAML) 기반의 개입 선택**, 그리고 **RAG를 통한 근거 보강**을 결합하여 “행동 변화”에 초점을 맞춘 점에서 차별성이 있다.

구현 관점에서, Android–FastAPI–LangGraph–Firestore–Pinecone–LLM API로 이어지는 전체 파이프라인을 구축하였고, **세션 라우팅(/session/init)**, **상태 복원(checkpointer)**, **세션/메시지 저장(Repo)**을 통해 **앱 재접속 시에도 대화가 누락 없이 복원되는 상담 경험**을 제공하도록 설계하였다.

---

## 5.2. 검증 결과 요약(파일럿)

1주차 상담 직후 파일럿 설문(n=2) 기반 평가에서 다음을 확인하였다.

- **스트레스 감소(평가항목 A)**: 평균 4.0으로 **긍정**
- **원인 이해(평가항목 B)**: 평균 4.0으로 **긍정**
- **사용성/이해도(평가항목 D)**: 평균 4.75로 **매우 긍정**
- **10주 지속 가능성(평가항목 C)**: 평균 3.5로 **보통(개선 여지)**

즉, 서비스가 “사용 가능한 형태로 작동”하며(UX/이해도), 단기적으로는 “스트레스 완화/인지적 명료화”에 기여할 가능성을 보였으나, **장기 지속(과제 수행/재상담 의지)** 측면은 동기 강화 설계가 추가로 필요하다는 결론을 얻었다.

---

## 5.3. 한계 및 해석상의 주의

본 프로젝트의 평가는 표본 수(n=2)가 매우 적은 파일럿이며, 10주 사용을 통한 실제 지출 변화/재발률 감소 등 **장기 성과를 검증하지 못했다**는 한계가 있다. 또한 LLM 기반 상담의 특성상 **환각/편향 가능성**, 사용자 입력의 다양성에 따른 **개입 품질 편차**가 발생할 수 있으므로, 향후 더 강한 가드레일과 운영 정책(위험 발화 처리, 근거 제시 강화, 로그/모니터링)을 보완해야 한다.

---

## 5.4. 향후 개선 방향

다음 단계의 개선 과제는 크게 네 가지로 정리된다.

1) **지속성(Engagement) 강화**  
- 과제 수행을 “행동으로 이어지게” 만드는 동기 장치(리마인더 고도화, 보상/게임화(예: ‘은하계 키우기’), 작은 성공 피드백)를 도입한다.

2) **평가 확장(정량·정성)**
- n을 늘려 반복 측정(1주차~4주차 등) 및 로그 기반 지표(리텐션, 과제 수행률, 상담 종료률, 재진입률)를 추가한다.

3) **안전성/품질 가드레일 강화**
- 위험 상황(자해/타해/응급) 처리 루틴을 더 명확히 하고, General 답변에는 근거(스니펫/출처) 표기 정책을 강화한다.

4) **상담 프로토콜/콘텐츠 개선**
- Week별 과업 난이도 조절, 질문 템플릿 다변화, 저항/회피 상황 대응 패턴을 보강해 “이탈이 적은 10주 흐름”으로 개선한다.

---

## 5.5. 결론

종합하면, 본 프로젝트는 **회색지대 충동구매 사용자에게 접근 가능한 CBT 기반 코칭 챗봇**을 실제로 구현하고, **단기 지표에서 긍정적 가능성**(스트레스 감소/원인 이해/사용성)을 확인하였다. 향후에는 지속 가능성 강화를 중심으로 기능을 고도화하고, 더 큰 표본과 장기 관찰을 통해 본 서비스가 **Digital Therapeutics(DTx) 가능성을 갖는 행동 변화 도구**로 확장될 수 있음을 검증하는 것이 다음 목표이다.


# 6. 부록

## 6.1. 설문조사 구글 폼 링크
- [배경: 충동 소비 경험 및 소비 코칭 서비스 사용 경험 조사](https://forms.gle/T9BfT5PZQHajGazn6)
- [평가 설문조사](https://forms.gle/WkxrS6XowhmhadPH8)


## 6.2. 참고 문헌

1. Black, D. W. (2007). A review of compulsive buying disorder. World Psychiatry, 6(1), 14–18. https://doi.org/10.1002/j.2051-5545.2007.tb00132.x
2. Darrat, A. A., Darrat, M. A., & Amyx, D. (2016). How impulse buying influences compulsive buying: The central role of consumer anxiety and escapism. Journal of Retailing and Consumer Services, 31, 103–108. https://doi.org/10.1016/j.jretconser.2016.03.009
3. Leite, P. L., Pereira, V. M., Nardi, A. E., & Silva, A. C. (2014). Psychotherapy for compulsive buying disorder: A systematic review. Psychiatry Research, 219(3), 411–419. https://doi.org/10.1016/j.psychres.2014.06.013
4. Lejoyeux, M., Adès, J., Tassain, V., & Solomon, J. (1997). Phenomenology and psychopathology of uncontrolled buying. American Journal of Psychiatry, 154(2), 263–267. https://doi.org/10.1176/ajp.154.2.263
5. Miltenberger, R. G., Redlin, J., Crosby, R., Stickney, M., Mitchell, J., Wonderlich, S., & Smyth, J. (1995). Direct and retrospective assessment of factors contributing to compulsive buying. Journal of Behavior Therapy and Experimental Psychiatry, 26(3), 291–300. [https://doi.org/10.1016/0005-7916(95)00017-8](https://doi.org/10.1016/0005-7916(95)00017-8)
6. Mitchell, J. E., Burgard, M., Faber, R., Crosby, R. D., & de Zwaan, M. (2006). Cognitive behavioral therapy for compulsive buying disorder. Behaviour Research and Therapy, 44(12), 1859–1865. https://doi.org/10.1016/j.brat.2006.01.010
7. Müller, A., Mitchell, J. E., Crosby, R. D., Cao, L., Johnson, J., Claes, L., de Zwaan, M. (2013). Estimated prevalence of compulsive buying in Germany and its association with sociodemographic characteristics and depressive symptoms. Psychiatry Research, 210(3), 857–862. https://doi.org/10.1016/j.psychres.2013.08.018
8. Rodrigues, R. I., Lopes, P., & Varela, M. (2021). Factors affecting impulse buying behavior of consumers. Frontiers in Psychology, 12, 697080. https://doi.org/10.3389/fpsyg.2021.697080
9. Tavares, H., Lobo, D. S. S., Fuentes, D., & Black, D. W. (2008). Compulsive buying disorder: A review and a case vignette. Revista Brasileira de Psiquiatria, 30(Suppl 1), S16–S23. https://doi.org/10.1590/S1516-44462008000500005
10. Verplanken, B., Herabadi, A. G., Perry, J. A., & Silvera, D. H. (2005). Consumer style and health: The role of impulsive buying in unhealthy eating. Psychology & Health, 20(4), 429–441. https://doi.org/10.1080/08870440412331337084
11. Vaidyam, A. N., Torous, J., & Black, D. W. (2024). Experiences with large language model chatbots for mental health: A qualitative study. arXiv preprint arXiv:2401.14362. https://arxiv.org/abs/2401.14362
12. Dartmouth College. (2025, March). First therapy chatbot trial yields mental health benefits. Dartmouth News. https://home.dartmouth.edu/news/2025/03/first-therapy-chatbot-trial-yields-mental-health-benefits
13. OM1. (2023). People are using ChatGPT as a therapist. Mental health experts have some concerns. OM1 Insights. https://www.om1.com/resource/people-are-using-chatgpt-as-a-therapist-mental-health-experts-have-some-concerns

