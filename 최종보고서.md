# 1. Team Info (팀 정보)

- **과제명**: 비임상적 소비 스트레스를 겪는 20대 여성을 위한, 인지행동치료 기반 LangGraph 상담 챗봇
- **팀 정보**: 28팀 e스타트
- **팀 구성원**
    - 유희정(1976250): 리더, 기획, 논문 조사, 프론트엔드, 백엔드
    - 최윤우(2176387): 팀원, DB(Firestore) 구조 설계
    - 이경림(1871033): 팀원, 기획, 논문조사, 제출 과제 준비

# 2. Project-Summary (과제 요약)

## 2.1. 문제 정의

### 2.1.1. 배경

### 1) 충동 소비(IB)와 강박적 소비장애(CBD)의 정의

- **충동 소비(Impulse Buying, IB)**: “Impulse purchases occur when there is a sudden and strong emotional desire, which arises from a reactive behavior that is characterized by low cognitive control… despite being aware of the negative effects of buying, there is an enormous desire to immediately satisfy the most pressing needs.” 감정적 충동과 낮은 자기 통제 속에서 이루어지는, 즉각적인 욕구 충족을 목표로 한 구매 (Rodrigues et al.,2021)
- **강박적 소비장애(Compulsive Buying Disorder, CBD)**
    - “excessive shopping cognitions and buying behavior that leads to distress or impairment.” 과도한 구매 사고 및 행동으로 인해 개인의 삶에 손상이나 고통을 초래하는 장애 (Black, 2007).
    - 진단 기준 (Black, 2007; Tavares et al., 2008)
        - 지속적 구매 충동: 반복적이고 저항하기 어려운 구매 욕구
        - 통제 실패: 불필요한 물품을 반복적으로 구입
        - 부정적 결과: 심각한 재정적 문제, 정서적 고통, 사회적 기능 저하
        - 배제 기준: 조증 상태 등 다른 정신질환으로 설명되지 않아야 함

### 2) 충동 소비(IB)와 강박적 소비장애(CBD)의 연결성

충동구매(Impulse Buying, IB)와 강박적 소비장애(Compulsive Buying Disorder, CBD)는 모두 계획되지 않은 즉흥적 구매와 관련이 있다는 점에서 공통점을 가지지만, 그 심각성과 결과에서 차이를 보인다. IB는 일시적이고 상황에 따라 발생할 수 있는 소비 행태로, 구매 후 후회나 과소비 경험을 유발하나 일상적 수준에서 머무를 수 있다. 반면, CBD는 반복적이고 만성적으로 지속되는 구매 충동으로, 개인이 통제하기 어려울 정도로 강력하며 결과적으로 심각한 재정적·정서적 손해를 초래한다 (Black, 2007; Tavares et al., 2008). 특히 연구에 따르면, 청소년기나 초기 성인기의 통제되지 않은 IB는 시간이 지남에 따라 만성적·재발적 양상을 띠며 CBD로 발전할 가능성이 높다 (Tavares et al., 2008; Black, 2007). 따라서 IB는 단순한 소비 습관 차원을 넘어, 방치될 경우 병리적 수준의 장애로 악화될 수 있는 전구 단계(preclinical stage)로 이해할 수 있으며, 이 시점에서의 개입은 CBD로의 진행을 예방하는 데 중요한 역할을 한다.

### 3) 충동 소비(IB)와 강박적 소비장애(CBD)의 회색 지대

현대 사회에서 충동성 소비(Impulse Buying, IB) 는 많은 젊은 층, 특히 20대 여성 사이에서 빈번하게 나타나지만, 이들이 겪는 어려움은 병리적 수준(Compulsive Buying Disorder, CBD, 강박적 소비장애) 에 이르지는 않아 진단이나 치료 대상이 되지 않는 경우가 많다.
이들이 처한 '회색지대'에는 다음과 같은 문제들이 존재한다.<br>

- **진단 기준 미달**: CBD 수준으로 진단받을 만한 기준은 충족하지 않지만, 반복적인 과소비 충동과 후회 경험이 반복된다.
- **생활 불편 및 스트레스**: 소비 후 후회, 채무 압박, 자기 통제 실패 경험 등이 정서적 부담과 스트레스를 유발한다.
- **심리적 진입장벽**: 정식 심리 상담이나 치료는 '회색 지대'에 위치한 사람이 감당하기에는 비용 부담, 시간 부담, 낙인 문제 등으로 인해 접근성이 낮다.
- **CBD로의 전이 가능성**: 일부 연구에서는 IB가 방치되면 CBD 수준으로 발전할 가능성이 있음이 제시된다.(Black, 2007; Tavares et al., 2008)

### 4) 설문조사를 통해 발견한 충동 소비(IB)와 강박적 소비장애(CBD)의 회색 지대

아래는 올해 9월 2일부터 9월 6일까지, 총 5일 간 학내 커뮤니티를 통해 20대 여성을 대상으로 진행한 설문조사 결과이다.

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/1635f801-e7b3-4839-9bfe-9a20175defa9" />

### 2.1.2. 문제 정의

강박적 소비장애(Compulsive Buying Disorder, CBD) 는 반복적이고 통제하기 어려운 구매 충동을 특징으로 하며, 결국 재정적·정서적 손해로 이어진다 (Tavares et al., 2008). 임상 연구에 따르면 CBD 환자의 80~94%가 여성으로 보고된다(Tavares et al., 2008).

그러나 모든 문제가 CBD로 진단되는 것은 아니다. 실제로 많은 소비자들이 CBD 진단 기준에는 해당하지 않지만, 반복적인 IB로 생활의 불편과 스트레스를 겪는 ‘회색지대’에 놓여 있다. 이들은 전문 상담을 받기에는 진입 장벽이 높고, 결과적으로 적절한 개입 없이 방치되는 상황에 처한다.

또한 연구는 IB가 단순한 습관 차원의 문제가 아니라, 반복될 경우 CBD로 진행될 수 있는 전구 단계임을 보여준다 (Black, 2007; Darrat et al., 2016). 특히 IB와 CBD는 공통된 심리적 기전(불안, 부정적 감정 대처)을 공유하며 (Darrat et al., 2016), 따라서 여성 집단에서 CBD 비율이 높은 점을 고려할 때, CBD로 진단되지 않은 심각한 IB 역시 여성에게서 더 빈번할 가능성이 있다.

### 2.1.3. 필요성

IB는 전체 소비의 40~80%를 차지하는 보편적 행태임에도 (Rodrigues et al., 2021), 반복되면 개인의 재정·정서적 건강을 심각하게 위협하며, 죄책감·후회·우울과 같은 부정적 감정 악순환을 유발한다 (Miltenberger et al., 1995; Verplanken et al., 2005). 그럼에도 불구하고 회색지대 소비자들은 기존의 고비용 치료 시스템으로 접근하기 어려워, 조기 개입의 공백이 존재한다.

따라서 본 프로젝트는 이러한 회색지대 소비자를 대상으로, 저비용·고접근성의 CBT 기반 개입 솔루션을 설계한다. 이를 통해 사용자가 소비 충동의 원인을 인식하고, 대체 행동 전략을 학습하며, 장기적으로는 CBD로의 진행을 예방하는 것을 목표로 한다.

## 2.2. 기존 서비스와의 비교

앱스토어에서 '소비 습관' 키워드로 검색했을 때 대개 소비 내역에 대한 기초적인 분석(카테고리별 소비 비율, 전월 대비 소비 증감, 지출 현황, 지출 패턴 분석)만을 제공해주는 가계부가 제일 많았다.  소비 습관 형성을 도와주는 서비스 또한 존재했는데, 그 수준이 단순한 챌린지를 제공하는 수준에 그쳤다. 각 유사 서비스의 소비 습관 코칭 기능과 한계점은 아래와 같다. 하지

- Fig, 굴비잇기, 지금 - 지금 실천하는 금융 챌린지
    - 챌린지 기반. 소비 유형을 MBTI 16가지 유형으로 나누어 각 사용자에게 맞는 챌린지
    - 사용자를 몇 가지 유형으로 나누기 때문에 완전 맞춤은 불가능하다는 단점이 있고, 소비자의 소비 패턴을 분석해도 각자에게 맞는 챌린지를 제공해줄 뿐, 챌린지 이외의 다른 해결책을 제시하지 못한다.
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/f57b31e3-4372-4ac1-a3b4-77e09176dc1b" />
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/04d93d8d-39b3-4405-9ac9-14356b026b2e" />

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/7a170919-c99b-4175-b227-3c027171032c" />
<img height="200" alt="Image" src="https://github.com/user-attachments/assets/e08ff2a4-e69a-4054-be6f-a788324302dc" />
<img height="200" alt="Image" src="https://github.com/user-attachments/assets/bc64d89d-82ef-4441-8c78-dd19b7e6dabe" />

<img height="200" alt="Image" src="https://github.com/user-attachments/assets/3f2285cd-7216-45ab-a4ac-badbb5ee7110" />

- 구매 습관 개선: 스마트한 소비 관리와 절약 앱(Kazuya Saito)
    - 설명: 물건 구매 전에 물건 구매 화면을 캡쳐하여 등록하면 구매를 저지할 수 있는 말을 이미지를 통해 자동생성하여 보여준다. 다만 매 소비 때마다 사진을 입력해야 하며, 소비 전에 구매 화면을 입력했을 때에 이 구매가 현명한 판단인지 아닌지 생각하게끔 하는 서비스이다.
    - 차별점: 충동 소비에 대한 체계적인 상담 프로그램을 적용하여 충동 소비 습관을 교정해주는 역할은 하지 못한다.
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/52daf50f-ddbe-4777-a39d-305fb1a02563" />
    <img height="200" alt="Image" src="https://github.com/user-attachments/assets/2fc2b2bf-c2aa-4c0f-b040-ac268e075cec" />

## 2.3. 제안 내용

충동구매(Impulse Buying, IB)와 강박적 소비장애(Compulsive Buying Disorder, CBD)는 서로 다른 진단적 범주에 속하지만, 두 현상은 공통된 심리·행동 기전을 공유한다. 구조방정식 모형 연구에 따르면, 충동구매는 불안을 유의하게 증가시키며, 이러한 불안은 다시 CBD와 밀접하게 연결되는 것으로 나타났다(Darrat, Darrat, & Amyx, 2016). 이는 IB가 단순한 소비 습관에 그치지 않고, 정서 조절 실패를 매개로 CBD로 진행할 수 있음을 보여준다.

한편, CBD 치료에서 가장 효과가 입증된 접근법은 인지행동치료(Cognitive Behavioral Therapy, CBT)이다(Mitchell, Burgard, Faber, Crosby, & de Zwaan, 2006;Leite, Pereira, Nardi, & Silva, 2014).

최근에는 ChatGPT와 같은 대형언어모델(LLM) 챗봇이 실제로 정신건강 상담 도구로 활용되는 사례가 늘어나고 있다(Dartmouth College, 2025; Leite, 2024; OM1, 2023; Vaidyam et al., 2024). 이는 LLM 챗봇이 전문 치료를 대체하지는 않더라도, 접근성이 높고 저비용으로 이용 가능한 ‘심리 코치’로 기능할 수 있음을 시사한다.

따라서 본 프로젝트는 CBD 치료에서 입증된 CBT 기법을 IB에 적용하는 것과 동시에, LLM 기반 챗봇을 코칭 솔루션으로 구현한다.

## 2.4. 기대 효과 및 의의

- CBD로 진단받지 못해 방치되는 회색지대 소비자들이 스스로 충동 소비의 원인을 인식하고 대체 전략을 학습하도록 돕는다.
- CBD로의 진행을 예방하며 개인의 재정적·정서적 건강을 보호한다.

## 2.5. 주요 기능 리스트
<span style="color:#0070C0;">
본 시스템은 Mitchell CBT(2006), Leite(2014), Black(2007), Muller(2015) 등의 프로토콜을 통합한 **LangGraph 기반 CBT 챗봇 오케스트레이션 구조**로 설계되었다. 사용자는 주 1회 ‘주간 상담 세션(Weekly Session)’과 매일 또는 필요 시 진행되는 ‘일일 실습 세션(Daily Practice Session)’, 그리고 그 외 자유롭게 이용 가능한 ‘일반 대화 세션(General Chat)’을 통해 자기조절 훈련을 수행한다.

각 세션은 Firestore에 저장된 상태(State)를 기반으로 이어지며, 주차별 상담 주제·목표·과제는 YAML 형식의 CBT 프로토콜 파일에서 자동 로드된다.

1. **주간 상담 세션(Weekly Session; LangGraph 기반 CBT 프로토콜)**
    - ChatGPT API를 통해 주차별 상담 주제(목표·출구조건·과제 등)가 반영된 CBT 대화 시나리오 자동 생성
    - 회피·부정확 입력 시 InterventionDecider 노드를 통해 L1~L5 수준별 개입(정보보강→정서안정→리스크 관리)
        
        
        | 단계 | 개입 수준 | 트리거 조건 | 개입 방식 | 예시 프롬프트 / 챗봇 행동 |
        | --- | --- | --- | --- | --- |
        | **L1 – 정보보강형 (Clarification / Information Support)** | 가장 기본 수준의 개입 | 사용자가 질문을 회피하거나 답변이 불완전할 때 (`completeness < 0.5`) | 질문을 더 구체화하거나 선택지를 제시하여 **명확한 사고를 유도** | “조금 더 구체적으로 말씀해주실래요? 어떤 상황이었는지 한두 문장으로 써볼까요?” |
        | **L2 – 동기탐색형 (Motivational Interviewing / Ambivalence Exploration)** | 중간 수준의 개입 | 회피·저항이 높거나, 인지적 회피(avoidance ≥ 0.6)가 감지될 때 | **동기면담(MI)** 기법을 사용해 가치 불일치, 변화 이유 탐색 | “이 행동이 도움이 되지 않는다고 느끼면서도 계속하게 되는 이유가 있을까요?” |
        | **L3 – 일관성정렬형 (Cognitive Dissonance / Thought Alignment)** | 고급 개입 | 이전 응답과 모순되거나(`contradiction ≥ 0.5`), 자기비판·정당화 패턴이 반복될 때 | 과거 대화 요약과 현재 답변을 비교하여 **인지부조화 조정** | “지난주에는 ‘절제가 가능하다’고 하셨는데, 이번엔 ‘전혀 못하겠다’고 하셨어요. 두 생각 중 더 가까운 건 어떤 쪽일까요?” |
        | **L4 – 정서조절형 (Affect Regulation / De-escalation)** | 고강도 정서 개입 | 불안·수치심 등의 감정 신호(`affect.anxiety ≥ 0.7`) 감지 시 | **정서안정·호흡유도·자기위로 문장** 제공 | “지금 많이 긴장되셨을 것 같아요. 잠깐 숨을 고르고 천천히 다시 생각해볼까요?” |
        | **L5 – 안전관리형 (Safety / Crisis Handling)** | 즉각적 보호 개입 | 위험신호(`risk=True`): 자해·중독·경제위기 문장 탐지 | **상담 중단 + 도움 자원 안내 + 자동 플래그** | “지금 상황이 많이 힘들게 느껴지시죠. 잠시 멈추고, 전문 도움을 받을 수 있는 연결을 안내드릴게요.” |
    - LangGraph 전환 규칙에 따라 exit_criteria 충족 시 SummarizeUpdate → +7일 푸시 예약(MaybeScheduleNudge)
    - 상담 종료 후 주간 요약(Weekly Report) 및 개인 행동계획 자동 저장
2. 세션 관리 및 자동화 로직
    - **24시간 이내 재접속 시 이어하기**, 24시간 초과 시 동일 주차 재시작
    - **21일 이상 미접속 시 전체 리셋**
    - **LangGraph 상태 노드 구조**
        - LoadState → RouteSession → PickWeek → BuildPrompt → DecideIntervention → RunLLM → CheckExitOrPause → SummarizeUpdate → MaybeScheduleNudge
    - **Firestore 세션 상태 관리**
        - `sessions/{userId}/weekly/{week}/state`에 checkpoint 저장
        - 각 턴 요약 및 진행도 업데이트, version-lock으로 경합 방지
3. 푸시 알림 및 리마인더
    - 주간 세션 완료 후 +7일 뒤 **Cloud Tasks를 통해 푸시 예약**
    - 일일 실습 시간대(사용자 설정)에 자동 알림 발송
    - 리마인더는 Firestore의 `nudge_tasks` 컬렉션에 저장되어 LangGraph tail 노드(MaybeScheduleNudge)에서 트리거
4. 일반 대화 세션 (General Chat)
    - 주간/일일 세션 종료 후 자유 대화 가능
    - 사용자 질문 맥락에 따라 RAG를 통한 정보 제공
    - 세션 로그는 상담 이력과 분리 저장되어, 치료적 대화의 연속성 유지

**요약:**

이 시스템은 주차별 CBT 프로토콜을 **LangGraph 그래프 노드로 오케스트레이션**하여,

임상적 순서(Week-by-Week Goal)와 기술적 흐름(세션 타입·시간 정책·개입 로직)을 모두 자동 제어한다.

결과적으로 상담자는 사용자의 회피, 불안, 충동 상황에서도 **치료적 대화를 유지하며** 지속적인 행동변화를 유도한다.
</span>
# 3. Project-Design (과제 설계)

## 3.1 요구사항 정의

### 3.1.1 대상 및 범위

본 과제의 주요 대상은 20대 여성 중심의 **“IB 회색지대” 사용자**이다.

이들은 강박적 소비장애(CBD) 진단 기준에는 미치지 않지만 반복적인 충동소비로 인해 스트레스와 재정적 부담을 경험하는 집단이다.

서비스는 **모바일(Android)** 을 우선으로 하며, 사용자는 하루 1–3분의 **데일리 체크**와 주 1회 **회기형 상담**을 수행하는 것을 기본 사용 맥락으로 한다.

### 3.1.2 사용자 스토리 (대표)

- US-01 규칙 기록: 사용자는 “밤 10시 이후 쇼핑앱 금지” 같은 개인 규칙 준수 여부를 매일 10초 내로 기록할 수 있다.
(버튼 1~2회 탭으로 저장, 저장 후 당일 규칙 상태가 UI에 반영될 것)
- US-02 충동 맥락 로그: 사용자는 충동 발생 시간/장소/감정/강도(0–10) 를 빠르게 기록하고, 상담 시 이를 확인할 수 있다.
(폼 제출 시 practice_logs 생성, 최근 7/14/28일 조회 가능)
- US-03 자동사고→대안사고: 사용자가 “세일 놓치면 손해” 같은 자동사고를 입력하면, 챗봇은 즉시 대안사고 카드를 제안·저장한다.
(대안사고 카드가 생성되어 카드 보관함과 일일 세션에 노출될 것)
- US-04 If–Then 체크: 사용자는 “세일 알림 → 물 한 잔 후 앱 종료” 같은 If–Then 계획을 버튼으로 실행 체크할 수 있다.
(체크 시 실행률이 반영되고, 미체크 시 리마인드가 노출될 것)
- US-05 KPI 리포트: 사용자는 최근 1~4주간 무구매일, 규칙 준수율, 대안사고 사용률, If–Then 실행률을 리포트로 확인할 수 있다.
(지표가 수치/추세로 표시, 기간 필터 변경 시 재계산 또는 캐시 반환)
- US-06 보안/프라이버시: 사용자는 모든 데이터가 비공개로 안전 저장되고 본인만 접근함을 확인할 수 있다.
(로그아웃 상태 접근 차단, Firestore Rules 통과, 전송 HTTPS 보장)
- US-07 이어하기(24h): 사용자가 주간 상담 중 앱을 잠시 닫았다가 24시간 이내 재접속하면 중단 지점(checkpoint) 에서 그대로 이어진다.
(resume=true 응답, 동일 step_index로 재개될 것)
- US-08 만료 재시작(24h+): 주간 상담 중단 후 24시간 경과 시, 해당 주차를 처음부터 재시작한다.
(재접속 시 expired=true 공지, 동일 주차의 첫 질문부터 진행)
- US-09 프로그램 리셋(21d): 미완 상태로 21일 이상 미접속하면 프로그램이 Week1으로 리셋되고 안내를 받는다.
(첫 진입에 리셋 안내 토스트/모달, current_week=1 확인 가능)
- US-10 +7일 푸시: 사용자가 주간 세션을 완료하면 정확히 7일 뒤 리마인더 푸시를 받고, 탭 시 주간 라우터로 바로 진입한다.
(Cloud Tasks 예약 생성, 수신 시 딥링크로 /chat/start?pref=weekly 열릴 것)
- US-11 일일 리마인더: 사용자는 일일 실습 알림 시간대(아침/저녁) 를 설정·변경하고, 필요 시 스누즈할 수 있다.
(로컬/서버 스케줄 반영, 설정 변경 즉시 이후 알림에 적용)
- US-12 상담/실습 히스토리: 사용자는 과거 주간 상담 요약과 일일 입력 로그를 주차/날짜별로 조회할 수 있다.
(주차별 요약 본문/대안사고 카드 목록/If–Then 이력 열람 가능)
- US-13 계획 편집/추천: 사용자는 플랜 화면에서 규칙·If–Then 계획을 수정하고, 최근 고위험 단서/시간대 기반 추천을 받을 수 있다.
(상위 단서/시간대가 자동 제안으로 노출, 저장 시 다음 일일/주간에 반영)
- US-14 일반 대화(RAG): 사용자는 주간/일일 세션 외에 일반 질문을 하고, 앱은 로컬 문서(RAG) 를 통해 소비·심리 FAQ 답변을 제공한다.
(General 경로에서만 RAG 사용, CBT 주차 프롬프트와 분리 저장)
- US-15 안전 모드(L5): 사용자가 위기/위험 신호를 표현하면, 챗봇은 안전 자원 안내와 함께 상담을 일시 중단한다.
(긴급 메시지·지역 자원 링크 표시, 해당 턴은 일반 대화·주간 진행 중단 플래그)

### 3.1.3 기능 요구사항 (Functional)

### 계정/보안

- Firebase Auth(이메일 또는 익명) 기반 로그인
- 인증 토큰 검증을 거친 사용자만 데이터 접근 가능(Firestore Rules)

### 실습 세션

- **일일 입력 기록**: `practice_logs/{autoId}`로 저장
    - 항목: `week`, `timestamp`, `cue(단서)`, `affect(감정)`, `urge_intensity(0–10)`, `urge`, `alt_behavior(대체행동)`, `rule_check(규칙 준수)`
- **If–Then 실행 체크**: 주간 세션에서 설정된 계획을 버튼으로 기록(실행률 집계)
- **대안사고 카드 재노출**: CR 카드(자동사고→대안사고)를 일일 루틴에서 반복 노출/학습
- **리마인더**: 사용자 설정 시간(아침/저녁) 알림, 스누즈 지원
- **KPI 반영**: 무구매일/규칙 준수율/If–Then 실행률/대안사고 사용률을 캐시(`progress/current`)

### 상담 세션

- **세션 컨테이너**: `sessions/{sessionId}` 생성/조회(`week`, `status`, `started_at`, `last_activity_at`, `checkpoint`)
- **대화 로그**: `sessions/{sessionId}/messages/{autoId}`에 사용자/어시스턴트 메시지 저장
    - 필드: `user_id`, `session_type("weekly"|"daily"|"general")`, `week`, `role`, `text`, `created_at`
- **요약 메모리**: 세션 종료 시 `summaries/{autoId}`에 핵심 요약 생성·저장 → 다음 주차 프롬프트에 주입
- **개입 레벨링(L1~L5)**: 입력 품질/정서/위험 신호 기반으로 질문 톤·전략 동적 전환
- **주차 프로토콜 자동 로드**: `protocols/v1/weekN.yaml`(goals, exit_criteria, script_steps, prompt_seed)
- **출구/전환 규칙**: exit criteria 충족 시 `status="ended"`, `current_week`+1 (최대 10주, 이후 `program_status="completed"`)
- **이어하기/만료**: 24시간 내 재접속 시 checkpoint에서 재개, 초과 시 해당 주차 처음부터
- **장기 미접속 리셋**: 미완 상태 21일 이상 미접속 시 `current_week=1`로 리셋(내역 보존)
- **푸시 예약(+7일)**: 주간 세션 완료 시 Cloud Tasks로 7일 후 리마인더 예약(딥링크로 주간 세션 진입)
- **일반 대화 분리**: General 경로에서는 RAG/FAQ 답변 가능(프로토콜 오염 방지, 상담 세션과 로그 분리 저장)

### ~~리포트/대시보드~~

- ~~최근 7/14/28일 KPI(규칙 준수율, 무구매일, 대안사고 사용률, If–Then 실행률) 제공~~
- ~~Top 단서/시간대, 실패 요인 분석 제공~~

### 알림/스케줄

- 데일리 체크 리마인더 제공(오전/저녁 중 선택)
- 24시간 지연 시점 점검 알림 제공

### RAG 질의응답

- 소비 관련 FAQ에 대해 RAG 문서 기반 응답 제공

### ~~3.1.4 비기능 요구사항 (Non-Functional)~~

- ~~**성능**: 데일리 폼 저장 API p95 < 300ms, 대시보드 조회 < 1.0s~~
- ~~**보안**: Firestore 보안 규칙 적용, 전송 구간 HTTPS 필수~~
- ~~**확장성**: 동시 접속 1k DAU 기준 무중단 수평 확장(Cloud Run)~~

### ~~3.1.5 수용 기준 (Acceptance)~~

- ~~데일리 기록 시 `practice_logs/{YYYY-MM-DD}` 문서가 생성되고, 점수가 저장될 것~~
- ~~`plans` 컬렉션에서 사용자당 `active=true` 문서가 1개임을 확인할 수 있을 것~~
- ~~대시보드에서 최근 7/14일 KPI(규칙 준수율, If–Then 실행률 등)가 수치로 표시될 것~~

## 3.2. 전체 시스템 구성

### 3.2.1 아키텍처 개요

본 시스템은 모바일 앱, 백엔드 서버, 데이터베이스, 외부 LLM API로 구성된다.

- **클라이언트**: Android (Kotlin)
- **백엔드**: FastAPI (Chat API, Summary API, Spending API)
- **데이터**: Firebase Firestore, Firebase Auth
- **LLM**: ChatGPT API + RAG
- **배포**: Cloud Run(FastAPI), Firebase Hosting, Cloud Build

> <그림 1> 전체 시스템 구성도
<img width="3840" height="624" alt="Image" src="https://github.com/user-attachments/assets/ff2df76c-0ad0-4c24-a844-fa0f9c6d3ca1" />
> 

### 3.2.2 데이터 모델

Firestore 기반의 데이터 모델은 다음과 같다.

- `users/{uid}`: 사용자 기본 정보 (진행 주차, 상태, 마지막 접속 등)
- `~~users/{uid}/plans/{planId}`: 상담 플랜 (단계, active 여부 등)~~
- `users/{uid}/sessions/{sessionId}`: 상담 로그
    - `users/{uid}/sessions/{sessionId}/messages/{autoId}`: 상담 대화 로그 (사용자/AI 메시지)
    - `users/{uid}/sessions/{sessionId}/summaries/{autoId}`: 세션 요약본 (회기 종료 시 자동 생성)
- `users/{uid}/practice_logs/{autoId}`: 일일 기록(단서, 감정, 충동, 대체행동 등)
- `users/{uid}/progress/current`

> <그림 2> Firestore 기반 데이터 모델
<img width="500" alt="Image" src="https://github.com/user-attachments/assets/75bfa2eb-963d-475c-96b4-e6fd2a45a426" />

### ~~3.2.3 주요 API (요약)~~

- ~~**POST** `/daily-checkin`: 데일리 입력 저장 및 위험도 점수 산출~~
- ~~**GET** `/dashboard/summary`: KPI 리포트 조회~~
- ~~**POST** `/chat/session`: 회기 상담 시작/요약/플랜 반영~~
- ~~**POST** `/rag/answer`: 로컬 문서 기반 질의응답~~

### 3.2.3 처리 흐름 (시퀀스 요약)

1. 사용자가 앱에서 데일리 입력 제출
2. 서버는 위험도 점수를 계산하고 Firestore에 저장
3. 대시보드는 KPI 결과를 불러와 사용자에게 시각화 제공

### 3.2.4 데모 범위 (9/30 기준)

CBT 기법을 바탕으로 한 상담 세션 & 상담 세션 내용 저장

## 3.3. 주요 엔진 및 기능 설계

### **3.3.1 LangGraph 오케스트레이션 엔진**
> <그림 3> LangGraph 플로우
<img width="300" alt="Image" src="https://github.com/user-attachments/assets/5f57e623-351f-4dff-ae55-6267ce37fdf8" />

사용자가 API(`/chat/start` 또는 `/chat/send`) 호출 → `LoadState` 노드를 실행 (사용자의 현재 상태(`current_week` 등) DB에서 불러오기) → `RouteSession` 노드가 세션의 종류 결정

- **`RouteSession` 노드 로직**
    1. **21일 비활성 체크:** 사용자가 21일 이상 접속하지 않음 → `current_week`를 1로 리셋하고 **"WEEKLY"** (상담) 세션으로 강제 라우팅
    2. **활성 세션 체크:** `LoadState`가 DB에서 `state.weekly_session`을 성공적으로 불러옴 (아직 진행 중인 주간 상담이 있음) → **"WEEKLY"** (상담) 세션으로 라우팅합니다.
    3. **그 외:** **"GENERAL"** (일반) 세션으로 라우팅

**1. 상담 세션 (Weekly)**

1.  프로토콜 로드 (`PickWeek`)
    - `LoadState`에서 확인된 `state.current_week`(예: 3주차)에 해당하는 `protocols/v1/week3.yaml` 파일 불러오기
    - YAML 파일의 `goals`, `script_steps`, `exit_criteria` 등을 `state.protocol`에 저장
    - 만약 `state.weekly_session`이 없다면(이번 주차 첫 방문), `REPO.create_weekly_session`을 호출해 DB에 새 세션 생성
2. 기억(메모리) 로드 (`BuildPrompt`)
    - `_load_history`
        - **과거 요약본:** `REPO.get_past_summaries`를 호출 → 이전 주차의 세션 요약본 불러오기
        - **현재 대화:** `REPO.get_messages`를 호출 → 현재 주차의 모든 상세 대화(WEEKLY, DAILY 모두) 불러오기
    - `SYSTEM_TEMPLATE`에 `state.protocol`의 목표(`goals`), 단계(`script_steps`), 종료 조건(`exit_goals`) 설정
    - [과거 요약본 + 현재 대화]를 `history`로, 사용자 입력을 `user_message`로 하여 최종 프롬프트를 완성
3. LLM 응답 및 종료 판단 (`RunLLM`)
    - `LLM_CHAIN`이 구조화된 출력(`.with_structured_output(CounselorTurn)`)을 호출 → LLM은 `response_text`와 `session_goals_me`을 반환
        - `response_text` (사용자에게 보낼 답변) → `state.llm_output`에 저장
        - `session_goals_met` (YAML의 종료 조건을 만족했는지) → `state.exit`에 저장
4. 턴 저장 및 요약 생성 (`SummarizeUpdate`)
    - `persist_turn`을 호출 → 직전 대화(사용자 입력, AI 응답)를 DB에 **'턴' 단위로 저장**
    - **[핵심 분기]** `if state.exit == True:` (방금 N주차 상담이 끝났다고 LLM이 판단)
        - `_create_summary` 함수가 LLM을 **한 번 더 호출 →** N주차의 모든 상세 대화 내용을 기반으로 [N주차 요약본]을 생성 → `REPO.save_session_summary`를 호출해 요약본을 DB에 저장 ({N+1}주차 세션에서 이 요약본을 사용)
    - `state.exit == False:`'턴' 저장만 하고 요약은 생성하지 않음
5. 종료 (`END`)
    - 그래프가 종료
    - `main.py`는 `state.llm_output`에 담긴 AI 응답을 사용자에게 반환
**2. 일일세션 (Daily)**
    1. 프로토콜 로드 (건너뜀)
        - `cond_route_session`이 "DAILY"를 반환 → `PickWeek` 노드를 건너뛰고 `BuildPrompt`
        - `state.protocol`은 비어있음
    2. 기억(메모리) 로드 (`BuildPrompt`)
        - `_load_history` 함수가 `session_type == "DAILY"` 조건을 확인
        - **과거 요약본:** 이전 주차의 모든 세션 요약본 불러오기
        - **현재 대화:** `_load_history` 로직에 따라, 현재 N주차의 대화 중 `session_type == "weekly"`인 상세 대화만 불러오기 (**과거의 일일 대화는 불러오지 않음**)
        - `state.protocol`이 비어있으므로, `SYSTEM_TEMPLATE`은 기본값("Daily Check-in")으로 채워짐
    3. LLM 응답 및 종료 판단 (`RunLLM`)
        - `CounselorTurn`을 호출
        - `state.protocol`의 `exit_criteria`가 없음 → LLM은 `session_goals_met=False`를 반환 (`state.exit == False`)
    4. 턴 저장 (`SummarizeUpdate`)
        - `persist_turn`을 호출 → 일일 대화 턴을 DB에 저장
        - `if state.exit == False` 이고 `state.session_type == "DAILY"` → **'세션 요약'은 절대 생성되지 않음**
**3. 일반 세션 (General)**
- 프로토콜 로드 (건너뜀)
    - "GENERAL"로 라우팅 → `PickWeek`을 건너뛰고 `BuildPrompt`
- 기억(메모리) 로드 (`BuildPrompt`)
    - `_load_history` 함수가 `session_type == "GENERAL"` 조건을 확인
    - 현재 코드(`else: pass`)에 따라, **아무런 기억(요약본, 상세 대화)도 불러오지 않음**
    - `state.protocol`도 비어있음 → 완전한 기본 프롬프트로 LLM을 호출
- LLM 응답 및 종료 판단 (`RunLLM`)
    - `state.exit == False`
- 턴 저장 (`SummarizeUpdate`)
    - `persist_turn`을 호출 → '일반 대화' 턴을 DB에 저장
    - **'세션 요약'은 생성되지 않음**

### **3.3.2 CBT 프로토콜 (주차별 스펙)**

- `protocols/v1/week{N}.yaml` 구조:
`title`, `goals`, `exit_criteria`, `min_days_since_prev`, `script_steps`, `prompt_seed`, `system_tips`
- **주차 전환 조건** (`current_week + 1`)
    - `exit_criteria`가 **모두 충족**
    - 직전 세션 종료 시점으로부터 **`min_days_since_prev` 이상 경과**
    - 두 조건 중 하나라도 미충족 시 현재 주차를 유지하며 반복 세션을 진행
- `min_days_since_prev`로 급진전 방지(최소 7일 유지)

### **3.3.2 CBT 프로토콜 (주차별 스펙)**

- `protocols/v1/week{N}.yaml` 구조:
`title`, `goals`, `exit_criteria`, `min_days_since_prev`, `script_steps`, `prompt_seed`, `system_tips`
- **주차 전환 조건 :** `exit_criteria`가 **모두 충족**되고, 직전 세션 종료 시점으로부터 **`min_days_since_prev` 이상 경과**했을 때만 다음 주차(`current_week + 1`)로 자동 전환됨. 두 조건 중 하나라도 미충족 시 현재 주차를 유지하며 반복 세션을 진행.
- `min_days_since_prev`로 급진전 방지(최소 7일 유지).

### **3.3.3 개입 레벨링(Intervention L1~L5)**

- DecideIntervention 노드가 매 턴 입력 품질/회피/모순·정서 신호를 스코어링하여 L1~L5 결정.
- BuildPrompt에서 레벨별 템플릿을 주입하여 질문 형태·톤만 변경(프로토콜 단계는 유지).
    - L1 정보보강(불완전 응답 보정), L2 동기탐색(MI), L3 일관성정렬(과거-현재 차이 정렬), L4 정서조절(탈각성), L5 안전관리(위험시 중단·자원 안내).

### **3.3.4 세션 상태 및 시간 정책**

- 이어서 하기(24h): 마지막 활동 24시간 이내 복귀 시 checkpoint에서 재개, 24h 초과 시 해당 주차 처음부터.
- 리셋(21d): 미완 사용자 21일 이상 미접속 시 Week1로 리셋(내역은 보존).
- 완주 후 정책: `post_complete_mode` = `keep` | `reset_on_reentry` 선택.

### **3.3.5 푸시·스케줄 엔진**

- 주간 세션 완료 시 Cloud Tasks로 `schedule_time = now+7d` 예약 → Cloud Run 엔드포인트가 기동되어 FCM 발송.
- 일일 실습은 사용자 설정 시간대에 리마인더(아침/저녁 등).
- 모든 예약은 멱등성 필드(nudge_id, nudge_sent_at)로 중복 방지.

### **3.3.6 RAG**

- 인지행동치료(CBT) 레퍼런스 요약을 내장 문서로 임베딩하여 로컬 RAG 제공.

## 3.4. 주요 기능의 구현

### **3.4.1 데이터 모델(Firestore 요약)**

- `users/{uid}`: `protocol_version`, `current_week`, `program_status`, `last_seen_at`, `post_complete_mode`, `fcm_token`
- `sessions/{uid}/weekly/{sessionId}`: `week`, `status`(`in_progress`|`paused`|`expired`|`completed`), `started_at`, `last_activity_at`, `checkpoint`{`step_index`,`cursor`}, `exit_flags`, `nudge_id`, `nudge_scheduled_at`, `nudge_sent_at`
- `practice_logs/{uid}/{autoId}`: `week`, `type`, `timestamp`, `affect`, `urge_intensity`, `cue`, `alt_behavior`
- `messages/{uid}/{autoId}`: `session_type`(`weekly`|`daily`|`general`), `week?`, `session_id?,` `role`, `text`, `timestamp`

### **3.4.2 주요 API (FastAPI)**

- `POST /chat/start`
    - 동작: LoadState→RouteSession 수행, 이어하기/리셋 정책 적용, 초기 메시지/프롬프트 반환
    - 응답: {`session_type`, `session_id`, `week`, `resume`, `checkpoint`}
- `POST /chat/send`
    - 동작: Weekly/Daily/General 서브그래프 1턴 실행(DecideIntervention→RunLLM→CheckExitOrPause)
    - 부가: 메시지 저장, checkpoint 갱신, exit 시 SummarizeUpdate→MaybeScheduleNudge
- `POST /notify/weekly-nudge` (Cloud Tasks 콜백)
    - 동작: nudge 멱등 체크 후 FCM 발송, nudge_sent_at 기록
- `POST /daily-checkin`
    - 동작: 실습 입력 저장, If–Then 실행 체크, 대안사고 카드 노출 로직

### **3.4.3 LangGraph 구현 포인트**

- 조건부 엣지로 시간 규칙·Exit 분기 선언:
    - RouteSession: WEEKLY | DAILY | GENERAL + (21일 리셋)
    - 각 턴(start 노드부터 end를 노드를 한 번 거치는 것을 한 턴이라고 한다.)의 SummarizeUpdate 노드에서 state.exit == True면 요약을 생성하고 LLM invoke 종료.
- 주차=데이터: PickWeek가 주차 스펙 로드(weekNN.yaml), 그래프 노드 수는 고정(가독성↑).
- 개입 레벨 주입: DecideIntervention → BuildPrompt(level=...).
- 에러/재시도: 외부 API(LLM/FCM/Tasks) 호출 노드를 좁게 분리, 실패 시 로컬 재시도 1~2회.

### **3.4.4 이어하기/만료/리셋 구현**

- 매 턴 sessions.*.last_activity_at 업데이트.
- 재진입 시 LoadState→RouteSession에서
    - now - last_activity_at < 24h → resume=true
    - now - last_activity_at >= 24h → expired=true로 동일 주차 재시작
    - now - users.last_seen_at >= 21d & 미완 → 프로그램 리셋(Week1)

### **3.4.5 보안·프라이버시**

- Firestore Security Rules: 사용자 uid 스코프 격리, 읽기/쓰기 최소 권한.
- 전송 구간: HTTPS/TLS 필수, FCM/Cloud Tasks 내부 호출에 비밀 헤더(X-Internal-Auth).
- 비식별화: 메시지·로그에서 카드번호·계좌 등 PII 필터링(정규식), long-term 저장 전 마스킹.
- 멱등성: message_id/request_id, nudge_id로 중복 처리 방지.

## 3.5. 기타

### **3.5.1 윤리·안전 고려(Ethics & Safety)**

- 의료행위 아님 고지: 본 서비스는 치료보조·코칭 목적이며 의료행위를 대체하지 않음을 명시.
- 위험 콘텐츠 처리: L5 감지 시 즉시 안전 메시지, 지역 도움 자원 안내, 일반 대화 중단(로그 플래그).
- 데이터 최소 수집: 상담 목적 범위 내 최소 항목만 수집, 사용 목적 명시.

### **3.5.2 데이터 거버넌스/보관 정책**

- 보존기간: 기본 12개월, 사용자 요청 시 조기 삭제(soft delete → scheduled purge).
- 접근통제: 운영자 콘솔 최소 권한, 감사 로그.
- 버전 관리: protocol_version 고정으로 중간 변경 영향 차단, md 파일 Git PR 리뷰·롤백 가능.

### **3.5.3 운영/모니터링**

- 애플리케이션: Cloud Run 로그/메트릭, 오류율/지연 p95 모니터링.
- 알림 파이프라인: Cloud Tasks 실패 재시도·DLQ 점검, FCM 응답코드 수집(401/429/5xx).
- LLM 품질: 개입 레벨(L1~L5) 분포, exit 도달률, 회피감소 폭 등 주간 리포트.

### **3.5.4 리스크 및 한계**

- 모델 환각/편향: 프롬프트 가드레일과 템플릿으로 단계 이탈 억제, RAG는 General 경로로만 제한.
- 사용자 이탈: 24h/21d 규칙 기반 복귀 설계, +7일 리마인더로 재진입 유도.
- 데이터 민감성: 금전/정서 데이터 보호를 위한 규칙·마스킹·암호화 준수 필요.

참고 문헌

1. Black, D. W. (2007). A review of compulsive buying disorder. World Psychiatry, 6(1), 14–18. https://doi.org/10.1002/j.2051-5545.2007.tb00132.x
2. Darrat, A. A., Darrat, M. A., & Amyx, D. (2016). How impulse buying influences compulsive buying: The central role of consumer anxiety and escapism. Journal of Retailing and Consumer Services, 31, 103–108. https://doi.org/10.1016/j.jretconser.2016.03.009
3.Leite, P. L., Pereira, V. M., Nardi, A. E., & Silva, A. C. (2014). Psychotherapy for compulsive buying disorder: A systematic review. Psychiatry Research, 219(3), 411–419. https://doi.org/10.1016/j.psychres.2014.06.013
3. Lejoyeux, M., Adès, J., Tassain, V., & Solomon, J. (1997). Phenomenology and psychopathology of uncontrolled buying. American Journal of Psychiatry, 154(2), 263–267. https://doi.org/10.1176/ajp.154.2.263
4. Miltenberger, R. G., Redlin, J., Crosby, R., Stickney, M., Mitchell, J., Wonderlich, S., & Smyth, J. (1995). Direct and retrospective assessment of factors contributing to compulsive buying. Journal of Behavior Therapy and Experimental Psychiatry, 26(3), 291–300. [https://doi.org/10.1016/0005-7916(95)00017-8](https://doi.org/10.1016/0005-7916(95)00017-8)
5. Mitchell, J. E., Burgard, M., Faber, R., Crosby, R. D., & de Zwaan, M. (2006). Cognitive behavioral therapy for compulsive buying disorder. Behaviour Research and Therapy, 44(12), 1859–1865. https://doi.org/10.1016/j.brat.2006.01.010
6. Müller, A., Mitchell, J. E., Crosby, R. D., Cao, L., Johnson, J., Claes, L., de Zwaan, M. (2013). Estimated prevalence of compulsive buying in Germany and its association with sociodemographic characteristics and depressive symptoms. Psychiatry Research, 210(3), 857–862. https://doi.org/10.1016/j.psychres.2013.08.018
7. Rodrigues, R. I., Lopes, P., & Varela, M. (2021). Factors affecting impulse buying behavior of consumers. Frontiers in Psychology, 12, 697080. https://doi.org/10.3389/fpsyg.2021.697080
8. Tavares, H., Lobo, D. S. S., Fuentes, D., & Black, D. W. (2008). Compulsive buying disorder: A review and a case vignette. Revista Brasileira de Psiquiatria, 30(Suppl 1), S16–S23. https://doi.org/10.1590/S1516-44462008000500005
9. Verplanken, B., Herabadi, A. G., Perry, J. A., & Silvera, D. H. (2005). Consumer style and health: The role of impulsive buying in unhealthy eating. Psychology & Health, 20(4), 429–441. https://doi.org/10.1080/08870440412331337084
10. Vaidyam, A. N., Torous, J., & Black, D. W. (2024). Experiences with large language model chatbots for mental health: A qualitative study. arXiv preprint arXiv:2401.14362. https://arxiv.org/abs/2401.14362
11. Dartmouth College. (2025, March). First therapy chatbot trial yields mental health benefits. Dartmouth News. https://home.dartmouth.edu/news/2025/03/first-therapy-chatbot-trial-yields-mental-health-benefits
12. OM1. (2023). People are using ChatGPT as a therapist. Mental health experts have some concerns. OM1 Insights. https://www.om1.com/resource/people-are-using-chatgpt-as-a-therapist-mental-health-experts-have-some-concerns
