# coach_agent/graph/rewrite_tone.py
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.messages import AIMessage
from coach_agent.state_types import State
from coach_agent.settings import settings

# ë§íˆ¬ ë³€í™˜ ì „ìš© ê°€ë²¼ìš´ ëª¨ë¸ (gpt-4o-mini ì¶”ì²œ)
tone_llm = ChatOpenAI(
    model=settings.OPENAI_TONE_MODEL, 
    temperature=0.3,
    api_key=settings.OPENAI_API_KEY
)

# í˜ë¥´ì†Œë‚˜ ì£¼ì… í”„ë¡¬í”„íŠ¸
TONE_PROMPT = """
ë‹¹ì‹ ì€ "ì „ë¬¸ êµì • ì—ë””í„°"ì´ì "ë™í™” ì‘ê°€"ì…ë‹ˆë‹¤.
ì•„ë˜ ì£¼ì–´ì§„ [ì›ë³¸ ë©”ì‹œì§€]ì˜ **ì˜ë¯¸ì™€ í•µì‹¬ ë‚´ìš©ì€ ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ê³ **,
ë§íˆ¬ë§Œ **"ì–´ë¦°ì™•ìì˜ ì—¬ìš°" ìºë¦­í„°(ë£¨ì‹œ)**ì— ë§ê²Œ ë‹¤ë“¬ì–´ ì£¼ì„¸ìš”.

[ì‚¬ìš©ì ì •ë³´]
- **ì‚¬ìš©ì ë‹‰ë„¤ì„:** {nickname}
- **ì£¼ì˜:** ì›ë³¸ ë©”ì‹œì§€ì— ì´ ë‹‰ë„¤ì„ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´, **ì ˆëŒ€ë¡œ 'ì—¬í–‰ì'ë¡œ ë°”ê¾¸ì§€ ë§ê³  ë‹‰ë„¤ì„ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”.** (ë‹‰ë„¤ì„ì´ ì—†ì„ ë•Œë§Œ 'ì—¬í–‰ì'ë¼ê³  ë¶€ë¥´ì„¸ìš”.)

[êµì • ê°€ì´ë“œë¼ì¸]
1. **ë§íˆ¬ ë³€í™˜:**
   - ë”±ë”±í•œ '~ë‹ˆë‹¤/ìŠµë‹ˆë‹¤'ì²´ëŠ” ë¶€ë“œëŸ¬ìš´ **'~ìš”'ì²´**ë¡œ ë°”ê¾¸ì„¸ìš”.
   - ì ì ˆí•œ ì´ëª¨ì§€(âœ¨, ğŸŒ¿ ë“±)ë¥¼ 1~2ê°œ ì‚¬ìš©í•˜ì—¬ ë”°ëœ»í•¨ì„ ë”í•˜ì„¸ìš”.

2. **í†¤ ì¡°ì ˆ (Tone Control):**
   - **ì§€ë‚˜ì¹œ ë°œë„í•¨ ê¸ˆì§€:** "ì†Œì¤‘í•œ~", "ì™„ì „~", "~ìš©!" ì²˜ëŸ¼ ë„ˆë¬´ ê°€ë³ê±°ë‚˜ ê³¼ì¥ëœ ìˆ˜ì‹ì–´ëŠ” ë„£ì§€ ë§ˆì„¸ìš”.
   - **ì§€í˜œë¡­ê³  ì°¨ë¶„í•˜ê²Œ:** ì›ë³¸ì˜ ì¸ì‚¬ê°€ "ë°˜ê°€ì›Œìš”"ë¼ë©´ "ì •ë§ ë°˜ê°€ì›Œìš”!" ì •ë„ë¡œë§Œ ë‹¤ë“¬ê³ , ë¬¸ì¥ì˜ ë³¸ë˜ ì˜ë¯¸ë¥¼ í›¼ì†í•˜ì§€ ë§ˆì„¸ìš”.
   - **ê°„ê²°í•¨:** ë¬¸ì¥ì´ ë¶ˆí•„ìš”í•˜ê²Œ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ í•˜ì„¸ìš”.
   
3. **í˜¸ì¹­ ê·œì¹™ (Naming Rule):** [ì¤‘ìš”]
   - ë¬¸ë§¥ìƒ ì‚¬ìš©ìë¥¼ ì§€ì¹­í•´ì•¼ í•  ë•Œ, **'ë‹¹ì‹ ', 'ë„ˆ', 'íšŒì›ë‹˜', 'ê·¸ìª½' ë“±ì˜ ëŒ€ëª…ì‚¬ë¥¼ ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš”.**
   - ëŒ€ì‹  ë°˜ë“œì‹œ **'{nickname}ë‹˜'**ì´ë¼ê³  ë¶ˆëŸ¬ì£¼ì„¸ìš”.
   - (ì˜ˆ: "ë‹¹ì‹ ì˜ ìƒê°ì€ ì–´ë–¤ê°€ìš”?" â†’ "{nickname}ë‹˜ì˜ ìƒê°ì€ ì–´ë–¤ê°€ìš”?")

4. **ê°€ë…ì„± ë° ì¤„ë°”ê¿ˆ (Formatting):** [ë§¤ìš° ì¤‘ìš”]
   - **ì ˆëŒ€ë¡œ ê¸´ ì¤„ê¸€(Block of text)ë¡œ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.** ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ì½ê¸° í¸í•´ì•¼ í•©ë‹ˆë‹¤.
   - **ì˜ë¯¸ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ**ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. (í•œ ë¬¸ì¥ì´ ê¸¸ì–´ì§€ê±°ë‚˜ í™”ì œê°€ ë°”ë€Œë©´ ì¤„ì„ ë°”ê¾¸ì„¸ìš”.)
   - íŠ¹íˆ, ë§ˆì§€ë§‰ì— **ì‚¬ìš©ìì—ê²Œ ë˜ì§€ëŠ” ì§ˆë¬¸**ì€ ì• ë‚´ìš©ê³¼ **í•œ ì¤„ ë„ì›Œì„œ(ë¹ˆ ì¤„ ì‚½ì…)** ëˆˆì— ì˜ ë„ê²Œ ë°°ì¹˜í•˜ì„¸ìš”.
   
   (ì˜ˆì‹œ êµ¬ì¡°:
    ì¸ì‚¬ ë° ê³µê°...
    (ë¹ˆ ì¤„)
    ì„¤ëª… ë‚´ìš©...
    (ë¹ˆ ì¤„)
    ì§ˆë¬¸?)
    
[ì›ë³¸ ë©”ì‹œì§€]
{original_text}

[ìˆ˜ì •ëœ ë©”ì‹œì§€]
(ì˜¤ì§ ìˆ˜ì •ëœ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”)
"""

def rewrite_tone(state: State) -> dict:
    # 1. RunLLMì—ì„œ ìƒì„±ëœ ì›ë³¸ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    original_text = state.llm_output
    
    # í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ íŒ¨ìŠ¤
    if not original_text:
        return {}
    
    # ë‹‰ë„¤ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    user_nickname = state.nickname or "ì—¬í–‰ì"  # ê¸°ë³¸ê°’

    # 2. ë§íˆ¬ ë³€í™˜ ì‹¤í–‰
    chain = ChatPromptTemplate.from_template(TONE_PROMPT) | tone_llm
    rewritten_text = chain.invoke({
        "original_text": original_text,
        "nickname": user_nickname
    }).content

    # ë””ë²„ê¹… ì¶œë ¥
    print(f"ğŸ”„ [Tone Polish] Nickname: {user_nickname}")
    print(f"ğŸ”„ [Tone Polish] Before: {original_text}... -> After: {rewritten_text}...")

    # 3. State ì—…ë°ì´íŠ¸ (ì¤‘ìš”!)
    # ê¸°ì¡´ messagesì˜ ë§ˆì§€ë§‰(RunLLMì´ ë„£ì€ ê²ƒ)ì„ ë®ì–´ì“°ê±°ë‚˜ êµì²´í•´ì•¼ í•¨.
    # LangGraphì˜ messages reducerëŠ” 'append'ê°€ ê¸°ë³¸ì´ë¯€ë¡œ, 
    # ì—¬ê¸°ì„œëŠ” state.messagesë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ê¸°ë³´ë‹¤,
    # 'messages' í‚¤ë¡œ ë°˜í™˜í•˜ë˜, 'id'ë¥¼ ì´ìš©í•´ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜(ê³ ê¸‰),
    # ê°„ë‹¨í•˜ê²ŒëŠ” PersistTurn ì „ì— state.llm_outputì„ ê°±ì‹ í•˜ê³ ,
    # RunLLMì´ messagesì— ë°”ë¡œ append í•˜ì§€ ì•Šë„ë¡ íë¦„ì„ ì¡°ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ.
    
    # [ì „ëµ ìˆ˜ì •] 
    # RunLLMì€ messagesì— append í•˜ì§€ ì•Šê³  'ì„ì‹œ ì €ì¥'ë§Œ í•˜ê³ ,
    # ì´ RewriteTone ë…¸ë“œê°€ ìµœì¢…ì ìœ¼ë¡œ messagesì— append í•˜ëŠ” ë°©ì‹ì´ ê°€ì¥ ê¹”ë”í•¨.
    
    return {
        "llm_output": rewritten_text,  # ë³€í™˜ëœ í…ìŠ¤íŠ¸ë¡œ ê°±ì‹ 
        "messages": [AIMessage(content=rewritten_text)] # ìµœì¢… ë©”ì‹œì§€ ì¶”ê°€
    }